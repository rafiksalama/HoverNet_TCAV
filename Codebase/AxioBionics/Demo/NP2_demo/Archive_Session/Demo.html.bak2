<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURO PRO 2 - Complete Demo V5</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light Mode Colors */
            --bg-primary: #f5f7fa;
            --bg-secondary: white;
            --bg-card: white;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e0e0e0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

            /* Theme Colors */
            --color-pink: #ff9a9e;
            --color-green: #a8edea;
            --color-purple: #d299c2;
            --color-orange: #fdcb6e;
            --color-blue: #3498db;
            --color-green-status: #27ae60;
            --color-red-status: #e74c3c;
        }

        /* Dark Mode */
        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #3a3a3a;
            --text-primary: #ecf0f1;
            --text-secondary: #95a5a6;
            --border-color: #4a4a4a;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* ===== SPLASH SCREEN ===== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 9999;
        }

        .splash-screen.hidden {
            display: none;
        }

        /* ===== LOGIN SCREEN ===== */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 10px;
            letter-spacing: -1px;
        }

        .login-logo .neuro {
            color: #1e3a8a;
        }

        .login-logo .pro {
            color: #93c5fd;
        }

        .login-subtitle {
            color: #60a5fa;
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 30px;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-input {
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-select {
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            cursor: pointer;
        }

        .login-btn {
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .splash-logo {
            font-size: 4rem;
            font-weight: 900;
            letter-spacing: -2px;
        }

        .splash-logo .neuro {
            color: #1e3a8a;
        }

        .splash-logo .pro {
            color: #93c5fd;
        }

        .splash-by {
            margin-top: 40px;
            color: #60a5fa;
            font-size: 1.5rem;
            font-weight: 600;
        }

        /* ===== HEADER BAR ===== */
        .header-bar {
            background: var(--bg-secondary);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            transition: background 0.3s;
        }

        .header-left {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .home-btn {
            padding: 8px 16px;
            background: var(--color-blue);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .home-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .templates-dropdown {
            padding: 8px 40px 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%233498db' d='M6 9L1 4h10z'/%3E%3C/svg%3E") no-repeat right 10px center;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            appearance: none;
        }

        .settings-icon {
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 20px;
        }

        /* ===== SCREEN SYSTEM ===== */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ===== DASHBOARD - CHANNELS GRID ===== */
        .channels-container {
            padding: 20px;
            overflow-x: auto;
        }

        .channels-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 15px;
            min-width: 900px;
        }

        .channel-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            border-top: 3px solid;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.3s;
        }

        .channel-card.active {
            outline: 3px solid var(--color-green-status);
            outline-offset: 0;
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.3), 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .channel-card.ch-1,
        .channel-card.ch-2 {
            border-top-color: var(--color-pink);
        }

        .channel-card.ch-3,
        .channel-card.ch-4 {
            border-top-color: var(--color-green);
        }

        .channel-card.ch-5,
        .channel-card.ch-6 {
            border-top-color: var(--color-purple);
        }

        .channel-card.ch-7,
        .channel-card.ch-8 {
            border-top-color: var(--color-orange);
        }

        .channel-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .channel-battery {
            font-size: 11px;
            color: var(--color-green-status);
            margin-bottom: 8px;
        }

        .channel-intensity {
            font-size: 48px;
            font-weight: 900;
            line-height: 1;
            margin: 10px 0;
            color: var(--text-primary);
        }

        .channel-stats {
            font-size: 11px;
            color: var(--text-secondary);
            margin: 8px 0;
            text-align: center;
        }

        .channel-muscle {
            font-size: 12px;
            color: var(--text-primary);
            text-align: center;
            margin: 8px 0;
            font-weight: 500;
        }

        .channel-controls {
            display: flex;
            gap: 8px;
            width: 100%;
            margin-top: 8px;
        }

        .channel-progress-wrapper {
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 4px;
            margin-top: 6px;
            overflow: hidden;
            position: relative;
        }

        .channel-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, var(--color-blue), var(--color-green-status));
            transition: width 0.3s ease;
        }

        .channel-progress-label {
            position: absolute;
            top: -16px;
            right: 0;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .channel-btn {
            flex: 1;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #d1d5db;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .channel-btn:hover {
            background: #9ca3af;
            transform: scale(1.1);
        }

        .channel-btn:active {
            transform: scale(0.95);
        }

        /* ===== GARMENT SETUP OVERVIEW ===== */
        .garment-overview {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto 100px;
        }

        .garment-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .garment-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: background 0.3s;
        }

        .garment-card h2 {
            background: var(--color-blue);
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .garment-image {
            width: 100%;
            max-height: 250px;
            object-fit: contain;
            margin: 15px 0;
        }

        .intensity-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .intensity-table th {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 8px 4px;
            border: 1px solid var(--border-color);
            font-weight: 600;
        }

        .intensity-table td {
            padding: 8px 4px;
            border: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-primary);
        }

        .intensity-table .channel-label {
            background: var(--bg-primary);
            font-weight: 600;
        }

        .setup-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: var(--color-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .setup-btn:hover {
            background: #2980b9;
        }

        /* ===== DETAIL SCREENS ===== */
        .detail-screen {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto 100px;
        }

        .detail-title {
            background: var(--color-blue);
            color: white;
            padding: 12px 20px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 700;
        }

        .detail-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
        }

        .channels-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .detail-channel-card {
            background: white;
            border: 3px solid;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .detail-channel-card.active {
            box-shadow: 0 0 0 4px rgba(39, 174, 96, 0.35);
            position: relative;
        }

        .detail-channel-card.active:after {
            content: 'ACTIVE';
            position: absolute;
            top: 8px;
            right: 12px;
            background: var(--color-green-status);
            color: #fff;
            font-size: 10px;
            padding: 3px 6px;
            border-radius: 4px;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .detail-channel-card.pink {
            border-color: var(--color-pink);
            background: #fff5f7;
        }

        .detail-channel-card.green {
            border-color: var(--color-green);
            background: #f0fffe;
        }

        .detail-channel-card.purple {
            border-color: var(--color-purple);
            background: #faf5f9;
        }

        .detail-channel-card.orange {
            border-color: var(--color-orange);
            background: #fffbf5;
        }

        body.dark-mode .detail-channel-card.pink {
            background: #2d1a1d;
        }

        body.dark-mode .detail-channel-card.green {
            background: #1a2d2c;
        }

        body.dark-mode .detail-channel-card.purple {
            background: #2a1d28;
        }

        body.dark-mode .detail-channel-card.orange {
            background: #2d2719;
        }

        .channel-header {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 15px;
        }

        .channel-num {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            border: 2px solid #ccc;
        }

        .detail-intensity {
            font-size: 60px;
            font-weight: 900;
            line-height: 1;
            margin: 15px 0;
            color: #333;
        }

        .detail-stats {
            font-size: 14px;
            color: #555;
            margin: 5px 0;
        }

        .muscle-label {
            margin-top: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }

        .channel-controls-detail {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
        }

        .detail-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #95a5a6;
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .detail-btn:hover {
            background: #7f8c8d;
            transform: scale(1.05);
        }

        .activities-panel {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            box-shadow: var(--shadow);
        }

        .activity-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .activity-row:last-child {
            border-bottom: none;
        }

        .activity-name {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .activity-name:hover {
            border-color: var(--color-orange);
            background: #fff8f0;
        }

        .activity-name.selected {
            border-color: var(--color-orange);
            background: #fff8f0;
        }

        .activity-buttons {
            display: flex;
            gap: 10px;
        }

        .activity-btn {
            padding: 12px 24px;
            border: 2px solid var(--color-blue);
            background: var(--bg-secondary);
            color: var(--color-blue);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .activity-btn:hover {
            background: var(--color-blue);
            color: white;
        }

        /* ===== DEVICE ASSIGNMENT ===== */
        .device-assignment {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto 100px;
        }

        .devices-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .device-card {
            display: flex;
            gap: 10px;
        }

        .device-btn {
            flex: 2;
            padding: 15px;
            border: 3px solid;
            border-radius: 8px;
            background: var(--bg-card);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .device-btn.master {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .device-btn.node {
            border-color: #27ae60;
            color: #27ae60;
        }

        .device-btn.selected {
            background: #f8f9fa;
        }

        .assign-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .assign-btn.assigned {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .network-tabs-container {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .tab-headers {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .tab-header {
            padding: 12px;
            text-align: center;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-header.active {
            border-bottom-color: var(--color-blue);
            color: var(--color-blue);
        }

        .network-setup-title {
            color: var(--color-blue);
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .network-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input-box {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input-box:focus {
            outline: none;
            border-color: var(--color-blue);
        }

        .save-btn {
            padding: 12px 40px;
            background: var(--color-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px auto 0;
            display: block;
        }

        .save-btn:hover {
            background: #2980b9;
        }

        /* ===== USAGE STATS ===== */
        .usage-container {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto 100px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }

        .date-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-arrow {
            cursor: pointer;
            font-size: 20px;
            color: var(--color-blue);
        }

        .chart-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
        }

        .chart-tab {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .chart-tab.active {
            background: var(--color-blue);
            color: white;
            border-color: var(--color-blue);
        }

        .chart-area {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 250px;
            padding: 50px 0 70px 0;
            /* Bottom padding reserves space for detached x-axis labels */
            gap: 15px;
            position: relative;
        }

        .axis-baseline {
            position: absolute;
            left: 5%;
            right: 5%;
            bottom: 48px;
            /* Above labels */
            height: 2px;
            background: var(--text-primary);
            opacity: 0.9;
            border-radius: 1px;
        }

        .bar-labels-row {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 8px;
            /* Final placement of day labels */
            display: flex;
            justify-content: space-around;
            padding: 0 10px;
            pointer-events: none;
        }

        .bar-labels-row .x-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .usage-y-axis {
            position: absolute;
            left: -42px;
            top: 20px;
            bottom: 20px;
            width: 36px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .usage-y-axis .tick::after {
            content: '';
            display: block;
            width: 6px;
            height: 1px;
            background: var(--border-color);
            margin-right: -8px;
        }

        .bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
            height: 100%;
            /* Ensure percentage bar heights compute correctly */
        }

        .bar {
            width: 100%;
            background: var(--color-blue);
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }

        .bar:hover {
            filter: brightness(1.08) saturate(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        }

        .bar-value {
            position: absolute;
            top: -38px;
            /* Above-bar default, enough clearance now that we added top padding */
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
            opacity: 0.8;
        }

        .bar-value.inside {
            top: auto;
            bottom: 6px;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
        }

        .bar-value.above-small {
            top: -54px;
            /* Extra lift for very short bars */
        }

        .bar-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 6px 8px;
            font-size: 11px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            white-space: nowrap;
            box-shadow: var(--shadow);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .bar-wrapper:hover .bar-tooltip {
            opacity: 1;
        }

        .bar-label {
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* ===== TEMPLATES ===== */
        .templates-container {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto 100px;
        }

        .template-section {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .template-header {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-primary);
        }

        .template-activities {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .template-activity {
            padding: 8px 16px;
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-activity:hover {
            background: var(--color-blue);
            color: white;
            transform: translateX(4px);
        }

        .template-activity.selected {
            background: var(--color-green-status);
            color: white;
            font-weight: 600;
        }

        .template-duration {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .duration-btn {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--color-blue);
            color: var(--color-blue);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .duration-btn:hover {
            background: var(--color-blue);
            color: #fff;
        }

        .duration-btn.selected {
            background: var(--color-green-status);
            border-color: var(--color-green-status);
            color: #fff;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
        }

        .start-template-btn {
            margin-top: 20px;
            width: 100%;
            padding: 15px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .edit-btn {
            float: right;
            color: var(--color-blue);
            cursor: pointer;
            font-size: 14px;
        }

        /* ===== BOTTOM NAVIGATION ===== */
        .bottom-nav {
            background: var(--bg-secondary);
            padding: 15px 20px;
            display: flex;
            gap: 20px;
            border-top: 2px solid var(--border-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            align-items: center;
            justify-content: space-between;
        }

        .nav-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 1;
        }

        .nav-group-left {
            justify-content: flex-start;
        }

        .nav-group-right {
            justify-content: flex-end;
        }

        .group-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-right: 10px;
            letter-spacing: 0.5px;
        }

        .nav-group-divider {
            width: 2px;
            height: 40px;
            background: var(--border-color);
            border-radius: 1px;
        }

        .nav-btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .mode-btn {
            padding: 6px 14px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .mode-btn.active {
            background: var(--color-blue);
            color: white;
            border-color: var(--color-blue);
        }

        .mode-btn:hover {
            background: var(--color-blue);
            color: white;
            transform: translateY(-1px);
        }

        .nav-btn:hover {
            background: var(--bg-primary);
        }

        .nav-btn.active {
            background: var(--color-blue);
            color: white;
            border-color: var(--color-blue);
        }

        /* ===== MODALS ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .modal-content.large {
            max-width: 900px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 28px;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-secondary);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-primary);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 15px;
            font-weight: 500;
        }

        .setting-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-btn {
            padding: 8px 20px;
            background: var(--color-blue);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: #2980b9;
        }

        .settings-btn.secondary {
            background: transparent;
            color: var(--color-blue);
            border: 2px solid var(--color-blue);
        }

        .settings-btn.secondary:hover {
            background: var(--color-blue);
            color: white;
        }

        .toggle-switch {
            position: relative;
            width: 80px;
            height: 30px;
            background: #ddd;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--color-blue);
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch.active .toggle-slider {
            left: 53px;
        }

        .toggle-labels {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            font-weight: 600;
            padding: 0 8px;
            color: white;
            height: 100%;
            align-items: center;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-blue);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .params-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .param-item {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: var(--bg-secondary);
        }

        .param-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-blue);
            margin-bottom: 8px;
        }

        .param-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Parameters form styles */
        .params-section {
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .params-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-blue);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .param-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .param-row:last-child {
            border-bottom: none;
        }

        .param-row-label {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .param-row-value {
            flex: 0 0 120px;
            text-align: right;
        }

        .param-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            text-align: center;
        }

        .param-input:focus {
            outline: none;
            border-color: var(--color-blue);
        }

        .param-input.editable {
            border-color: var(--color-green-status);
            background: rgba(39, 174, 96, 0.05);
        }

        .param-input.readonly {
            background: var(--bg-primary);
            border-color: var(--border-color);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .param-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--color-green-status);
            border-radius: 4px;
            background: rgba(39, 174, 96, 0.05);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .param-note {
            font-size: 11px;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            border-left: 3px solid var(--color-blue);
        }

        .param-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .param-badge.editable {
            background: var(--color-green-status);
            color: white;
        }

        .param-badge.readonly {
            background: var(--color-orange);
            color: white;
        }

        .params-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
        }

        .params-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .params-save-btn {
            background: var(--color-green-status);
            color: white;
        }

        .params-reset-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color) !important;
        }

        .status-bar {
            background: var(--color-green-status);
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .close-btn-screen {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 28px;
            cursor: pointer;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            z-index: 100;
        }

        /* ===== USER GUIDE STYLES ===== */
        .guide-container {
            padding: 20px 0;
        }

        .guide-progress {
            text-align: center;
            margin-bottom: 25px;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-blue);
        }

        .guide-step {
            display: none;
        }

        .guide-step.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .guide-icon {
            font-size: 64px;
            text-align: center;
            margin-bottom: 20px;
        }

        .guide-step-title {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .guide-step-content {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .guide-step-content p {
            margin-bottom: 15px;
        }

        .guide-step-content ul,
        .guide-step-content ol {
            margin: 15px 0 15px 25px;
        }

        .guide-step-content li {
            margin-bottom: 8px;
        }

        .guide-note {
            background: #f0f9ff;
            border-left: 4px solid var(--color-blue);
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #333;
        }

        body.dark-mode .guide-note {
            background: #1e3a5f;
            color: #e0e0e0;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #333;
        }

        body.dark-mode .warning-box {
            background: #3d2d1f;
            color: #ffd180;
        }

        .info-box {
            background: #d1f2eb;
            border-left: 4px solid #27ae60;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #333;
        }

        body.dark-mode .info-box {
            background: #1e3d34;
            color: #a8edea;
        }

        .demo-box {
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .demo-box h3 {
            color: var(--color-blue);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .support-box {
            background: var(--color-blue);
            color: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
        }

        .support-box p {
            margin: 8px 0;
        }

        .electrode-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .electrode-group h3 {
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .ch-indicator {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 700;
            margin-right: 8px;
            color: white;
        }

        .ch-indicator.pink {
            background: var(--color-pink);
        }

        .ch-indicator.green {
            background: var(--color-green);
        }

        .ch-indicator.purple {
            background: var(--color-purple);
        }

        .ch-indicator.orange {
            background: var(--color-orange);
        }

        .button-demo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .demo-btn-plus,
        .demo-btn-minus {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--color-blue);
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        .demo-btn-minus {
            background: #95a5a6;
        }

        .intensity-display-demo {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .template-demo {
            margin: 20px 0;
        }

        .template-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .template-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }

        .template-icon {
            font-size: 28px;
        }

        .device-role-demo {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .role-card {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .master-role {
            background: #fee;
            border: 2px solid #e74c3c;
            color: #c0392b;
        }

        .node-role {
            background: #efe;
            border: 2px solid #27ae60;
            color: #1e8449;
        }

        body.dark-mode .master-role {
            background: #3d1f1f;
            color: #ff7675;
        }

        body.dark-mode .node-role {
            background: #1f3d2a;
            color: #55efc4;
        }

        .troubleshooting-item {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .troubleshooting-item:last-child {
            border-bottom: none;
        }

        .troubleshooting-item h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .guide-navigation {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .guide-nav-btn {
            flex: 1;
            padding: 14px 24px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .guide-nav-btn.primary {
            background: var(--color-blue);
            color: white;
            border-color: var(--color-blue);
        }

        .guide-nav-btn:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .guide-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* ===== TUTORIAL STYLES ===== */
        .tutorial-container {
            padding: 20px 0;
        }

        .tutorial-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }

        .tutorial-tab {
            padding: 14px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            background: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tutorial-tab.active {
            border-bottom-color: var(--color-blue);
            color: var(--color-blue);
        }

        .tutorial-tab:hover {
            background: var(--bg-primary);
        }

        .tutorial-content {
            display: none;
        }

        .tutorial-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .tutorial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .tutorial-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .tutorial-duration {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            background: var(--bg-primary);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .video-player-demo {
            margin-bottom: 30px;
        }

        .video-placeholder {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 80px 40px;
            text-align: center;
            color: white;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .video-placeholder:hover {
            transform: scale(1.02);
        }

        .play-button-large {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 20px;
            border: 3px solid rgba(255, 255, 255, 0.8);
        }

        .video-placeholder p {
            font-size: 18px;
            font-weight: 600;
        }

        .tutorial-steps {
            margin-top: 30px;
        }

        .tutorial-steps h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .tutorial-step {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 8px;
            border-left: 4px solid var(--color-blue);
        }

        .tutorial-step.completed {
            border-left-color: var(--color-green-status);
            background: #d1f2eb;
        }

        body.dark-mode .tutorial-step.completed {
            background: #1e3d34;
        }

        .step-number {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: var(--color-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
        }

        .tutorial-step.completed .step-number {
            background: var(--color-green-status);
        }

        .step-content {
            flex: 1;
        }

        .step-content h4 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .step-content p {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .step-content ul {
            margin: 10px 0 10px 20px;
        }

        .step-content li {
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .step-highlight {
            background: #fff8e1;
            border-left: 3px solid #ffc107;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
        }

        body.dark-mode .step-highlight {
            background: #3d3520;
            color: #ffd54f;
        }

        .garment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .option-card {
            padding: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
        }

        .option-card strong {
            display: block;
            font-size: 18px;
            color: var(--color-blue);
            margin-bottom: 10px;
        }

        .option-card p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 5px 0;
        }

        .activity-selector-demo {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .activity-option {
            padding: 12px 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--color-blue);
            border-radius: 6px;
            color: var(--color-blue);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .activity-option:hover {
            background: var(--color-blue);
            color: white;
        }

        .intensity-guide {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .intensity-guide strong {
            color: var(--text-primary);
        }

        .intensity-guide ul {
            margin: 10px 0 0 20px;
        }

        .device-assignment-demo {
            margin: 15px 0;
        }

        .device-card-demo {
            padding: 20px;
            background: var(--bg-card);
            border: 3px solid var(--border-color);
            border-radius: 8px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 10px;
        }

        .device-card-demo.master {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .device-card-demo.node {
            border-color: #27ae60;
            color: #27ae60;
        }

        .status-badge {
            display: inline-block;
            margin-left: 10px;
            padding: 4px 12px;
            background: #d4edda;
            color: #155724;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.assigned {
            background: #d4edda;
            color: #155724;
        }

        .node-grid-demo {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .form-demo {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .form-row-demo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row-demo:last-child {
            margin-bottom: 0;
        }

        .form-row-demo label {
            flex: 0 0 150px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-row-demo input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        /* Controls locked state */
        body.controls-locked .channel-btn,
        body.controls-locked .nav-btn:not([onclick*="lockControls"]),
        body.controls-locked input,
        body.controls-locked select,
        body.controls-locked .template-activity {
            pointer-events: none;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .channels-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav-btn {
                font-size: 10px;
                padding: 8px 4px;
            }

            .garment-sections {
                grid-template-columns: 1fr;
            }

            .detail-content {
                grid-template-columns: 1fr;
            }

            .channels-panel {
                grid-template-columns: 1fr;
            }

            .network-form {
                grid-template-columns: 1fr;
            }

            .electrode-demo {
                grid-template-columns: 1fr;
            }

            .device-role-demo {
                grid-template-columns: 1fr;
            }

            .tutorial-tabs {
                grid-template-columns: 1fr 1fr;
            }

            .garment-options {
                grid-template-columns: 1fr;
            }

            .node-grid-demo {
                grid-template-columns: 1fr;
            }

            .form-row-demo {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-row-demo label {
                flex: none;
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-screen" id="login">
        <div class="login-container">
            <div class="login-logo">
                <span class="neuro">NEURO</span> <span class="pro">PRO 2</span>
            </div>
            <div class="login-subtitle">BY AXIO BIONICS</div>

            <form class="login-form" onsubmit="handleLogin(event)">
                <input type="text" id="login-name" class="login-input" placeholder="Your Name" required>
                <input type="email" id="login-email" class="login-input" placeholder="Email" required>
                <input type="password" id="login-password" class="login-input" placeholder="Password" required
                    minlength="6">

                <select id="login-role" class="login-select" required>
                    <option value="">Select Role</option>
                    <option value="Patient">Patient</option>
                    <option value="Clinician">Clinician</option>
                    <option value="Therapist">Therapist</option>
                    <option value="Administrator">Administrator</option>
                </select>

                <select id="login-plan" class="login-select" required>
                    <option value="">Select Plan</option>
                    <option value="Basic">Basic Plan</option>
                    <option value="Pro">Pro Plan</option>
                    <option value="Enterprise">Enterprise Plan</option>
                </select>

                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Splash Screen -->
    <div class="splash-screen hidden" id="splash">
        <div class="splash-logo">
            <span class="neuro">NEURO</span> <span class="pro">PRO 2</span>
        </div>
        <div class="splash-by">BY AXIO BIONICS</div>
    </div>

    <!-- Main App -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <div class="header-bar">
            <div class="header-left">
                <span
                    style="margin-left: 10px; padding: 8px 16px; background: var(--color-blue); color: white; border-radius: 4px; font-weight: 700; font-size: 14px;"
                    id="mode-indicator">MANUAL MODE</span>
                <div class="mode-switch-buttons" style="margin-left: 15px; display: flex; gap: 5px;">
                    <button class="mode-btn active" onclick="switchToMode('manual', this)"> Manual</button>
                    <button class="mode-btn" onclick="switchToMode('template', this)"> Template</button>
                </div>
                <span style="margin-left: 20px; font-weight: 600; color: var(--text-primary);"
                    id="user-name-display"></span>
                <button id="start-session-btn" class="home-btn" onclick="toggleSession()"
                    style="background: var(--color-green-status); margin-left: 10px;"> START</button>
                <span>Contraction Count: <strong id="contraction-count">0</strong></span>
                <span style="margin-left:10px;">Active Time: <strong id="active-time-any">0s</strong></span>
                <span style="margin-left:10px;">Active Utilization: <strong id="active-utilization">0%</strong></span>
                <button class="home-btn" style="margin-left:10px; background: var(--color-blue);"
                    onclick="exportChannelUsageCSV()"> Export Usage CSV</button>
                <span> <strong id="timer">00:00</strong></span>
                <span style="margin-left: 10px; color: var(--text-secondary);">Remaining: <strong
                    id="time-remaining">10:00</strong></span>
            </div>
            <div id="template-selector-container" style="display: none;">
                <span style="margin-right: 10px; font-weight: 600; color: var(--text-primary);">Select Template:</span>
                <select class="templates-dropdown" onchange="loadTemplate(this.value)">
                    <option value="">Choose a template...</option>
                    <option value="walking">Walking</option>
                    <option value="jogging">Jogging</option>
                    <option value="running">Running</option>
                    <option value="stairs">Stairs</option>
                    <option value="jumping">Jumping</option>
                </select>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span class="settings-icon" onclick="openModal('settings')"></span>
                <button class="home-btn" onclick="logout()" style="background: var(--color-red-status);">
                    Logout</button>
            </div>
        </div>

        <!-- SCREEN 1: DASHBOARD -->
        <div id="screen-dashboard" class="screen active">
            <div class="channels-container">
                <div class="channels-grid" id="channels-grid"></div>
            </div>
        </div>

        <!-- SCREEN 2: GARMENT SETUP OVERVIEW -->
        <div id="screen-garment-overview" class="screen">
            <div class="garment-overview">
                <div class="garment-sections">
                    <div class="garment-card">
                        <h2>BioShorts - Intensity not set</h2>
                        <img src="../../Res/Images/garmentpairing.png" alt="BioShorts" class="garment-image"
                            onerror="this.style.display='none'">
                        <table class="intensity-table">
                            <tr>
                                <th></th>
                                <th>Walking</th>
                                <th>Jogging</th>
                                <th>Running</th>
                                <th>Stairs</th>
                                <th>Jumping</th>
                            </tr>
                            <tr>
                                <td class="channel-label">CH 1-2 100%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                            </tr>
                            <tr>
                                <td class="channel-label">CH 3-4 100%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                            </tr>
                        </table>
                        <button class="setup-btn" onclick="switchScreen('bioshorts-detail', null)">Click to set
                            intensity for BioShorts</button>
                    </div>

                    <div class="garment-card">
                        <h2>BioSleeves - Intensity not set</h2>
                        <img src="../../Res/Images/garmentpairing.png" alt="BioSleeves" class="garment-image"
                            onerror="this.style.display='none'">
                        <table class="intensity-table">
                            <tr>
                                <th></th>
                                <th>Walking</th>
                                <th>Jogging</th>
                                <th>Running</th>
                                <th>Stairs</th>
                                <th>Jumping</th>
                            </tr>
                            <tr>
                                <td class="channel-label">CH 5-6 100%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                            </tr>
                            <tr>
                                <td class="channel-label">CH 7-8 100%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                                <td>0%</td>
                            </tr>
                        </table>
                        <button class="setup-btn" onclick="switchScreen('biosleeves-detail', null)">Click to set
                            intensity for BioSleeves</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 3: BIOSHORTS DETAIL -->
        <div id="screen-bioshorts-detail" class="screen">
            <div class="detail-screen">
                <div class="detail-title">BioShorts Set-Up </div>
                <div class="detail-content">
                    <div class="channels-panel">
                        <div class="detail-channel-card pink">
                            <div class="channel-header">
                                <div class="channel-num">1</div>
                                <div style="font-size: 11px; color: #e74c3c;">100%</div>
                                <div class="channel-num">2</div>
                            </div>
                            <div class="detail-intensity">0<span style="font-size: 24px;">%</span></div>
                            <div class="detail-stats">0.0 V</div>
                            <div class="detail-stats">R: 0 </div>
                            <div class="muscle-label">Muscle</div>
                            <div class="channel-controls-detail">
                                <button class="detail-btn" onclick="adjustChannel(1, -1)"></button>
                                <button class="detail-btn" onclick="adjustChannel(1, 1)">+</button>
                            </div>
                        </div>
                        <div class="detail-channel-card green">
                            <div class="channel-header">
                                <div class="channel-num">3</div>
                                <div style="font-size: 11px; color: #27ae60;">100%</div>
                                <div class="channel-num">4</div>
                            </div>
                            <div class="detail-intensity">0<span style="font-size: 24px;">%</span></div>
                            <div class="detail-stats">0.0 V</div>
                            <div class="detail-stats">R: 0 </div>
                            <div class="muscle-label">Muscle</div>
                            <div class="channel-controls-detail">
                                <button class="detail-btn" onclick="adjustChannel(3, -1)"></button>
                                <button class="detail-btn" onclick="adjustChannel(3, 1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="activities-panel">
                        <div class="activity-row">
                            <div class="activity-name selected" onclick="selectActivity(this)">Walking</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                        <div class="activity-row">
                            <div class="activity-name" onclick="selectActivity(this)">Jogging</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                        <div class="activity-row">
                            <div class="activity-name" onclick="selectActivity(this)">Running</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                        <div class="activity-row">
                            <div class="activity-name" onclick="selectActivity(this)">Stairs</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                        <div class="activity-row">
                            <div class="activity-name" onclick="selectActivity(this)">Jumping</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 4: BIOSLEEVES DETAIL -->
        <div id="screen-biosleeves-detail" class="screen">
            <div class="detail-screen">
                <div class="detail-title">BioSleeves Set-Up </div>
                <div class="detail-content">
                    <div class="channels-panel">
                        <div class="detail-channel-card purple">
                            <div class="channel-header">
                                <div class="channel-num">5</div>
                                <div style="font-size: 11px; color: #8e44ad;">100%</div>
                                <div class="channel-num">6</div>
                            </div>
                            <div class="detail-intensity">0<span style="font-size: 24px;">%</span></div>
                            <div class="detail-stats">0.0 V</div>
                            <div class="detail-stats">R: 0 </div>
                            <div class="muscle-label">Muscle</div>
                            <div class="channel-controls-detail">
                                <button class="detail-btn" onclick="adjustChannel(5, -1)"></button>
                                <button class="detail-btn" onclick="adjustChannel(5, 1)">+</button>
                            </div>
                        </div>
                        <div class="detail-channel-card orange">
                            <div class="channel-header">
                                <div class="channel-num">7</div>
                                <div style="font-size: 11px; color: #e67e22;">100%</div>
                                <div class="channel-num">8</div>
                            </div>
                            <div class="detail-intensity">0<span style="font-size: 24px;">%</span></div>
                            <div class="detail-stats">0.0 V</div>
                            <div class="detail-stats">R: 0 </div>
                            <div class="muscle-label">Muscle</div>
                            <div class="channel-controls-detail">
                                <button class="detail-btn" onclick="adjustChannel(7, -1)"></button>
                                <button class="detail-btn" onclick="adjustChannel(7, 1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="activities-panel">
                        <div class="activity-row">
                            <div class="activity-name selected" onclick="selectActivity(this)">Walking</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                        <div class="activity-row">
                            <div class="activity-name" onclick="selectActivity(this)">Jogging</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                        <div class="activity-row">
                            <div class="activity-name" onclick="selectActivity(this)">Running</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                        <div class="activity-row">
                            <div class="activity-name" onclick="selectActivity(this)">Stairs</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                        <div class="activity-row">
                            <div class="activity-name" onclick="selectActivity(this)">Jumping</div>
                            <div class="activity-buttons">
                                <button class="activity-btn">Test</button>
                                <button class="activity-btn">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 5: USAGE STATS -->
        <div id="screen-usage" class="screen">
            <div class="usage-container">
                <div class="stats-cards" id="usage-stats-cards"
                    style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:18px;">
                    <div class="stat-card"
                        style="background:var(--bg-card);padding:12px;border-radius:6px;box-shadow:var(--shadow);text-align:center;">
                        <div style="font-size:24px;"></div>
                        <div id="stat-total-hours" style="font-weight:700;font-size:18px;color:var(--color-blue);">--
                        </div>
                        <div style="font-size:11px;text-transform:uppercase;color:var(--text-secondary);">Hours (Period)
                        </div>
                    </div>
                    <div class="stat-card"
                        style="background:var(--bg-card);padding:12px;border-radius:6px;box-shadow:var(--shadow);text-align:center;">
                        <div style="font-size:24px;"></div>
                        <div id="stat-sessions" style="font-weight:700;font-size:18px;color:var(--color-blue);">--</div>
                        <div style="font-size:11px;text-transform:uppercase;color:var(--text-secondary);">Sessions</div>
                    </div>
                    <div class="stat-card"
                        style="background:var(--bg-card);padding:12px;border-radius:6px;box-shadow:var(--shadow);text-align:center;">
                        <div style="font-size:24px;"></div>
                        <div id="stat-contractions" style="font-weight:700;font-size:18px;color:var(--color-blue);">--
                        </div>
                        <div style="font-size:11px;text-transform:uppercase;color:var(--text-secondary);">Contractions
                        </div>
                    </div>
                </div>
                <div class="chart-header">
                    <div class="date-navigation">
                        <span class="nav-arrow" onclick="changeWeek(-1)" style="cursor: pointer;"></span>
                        <strong id="date-display">Week 21st Nov - 27th Nov</strong>
                        <span class="nav-arrow" onclick="changeWeek(1)" style="cursor: pointer;"></span>
                    </div>
                </div>

                <div class="chart-tabs">
                    <button class="chart-tab active" onclick="switchChartTab(this, 'weekly')">WEEKLY</button>
                    <button class="chart-tab" onclick="switchChartTab(this, 'monthly')">MONTHLY</button>
                    <button class="chart-tab" onclick="switchChartTab(this, 'yearly')">YEARLY</button>
                </div>

                <div class="chart-area">
                    <div class="bar-chart" id="usage-bar-chart">
                        <!-- Bars rendered dynamically -->
                        <div class="usage-fallback"
                            style="text-align:center;width:100%;color:var(--text-secondary);font-size:13px;">Loading
                            usage data</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 6: TEMPLATES -->
        <div id="screen-templates" class="screen">
            <div class="templates-container">
                <div class="template-section">
                    <div class="template-header">
                        BioShorts Alone - Intensity Set
                        <span class="edit-btn">Edit </span>
                    </div>
                    <div class="template-activities">
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'bioshorts', 'Walking')">a.
                            Walking</div>
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'bioshorts', 'Jogging')">b.
                            Jogging</div>
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'bioshorts', 'Running')">c.
                            Running</div>
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'bioshorts', 'Stairs')">d.
                            Stairs</div>
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'bioshorts', 'Jumping')">e.
                            Jumping</div>
                    </div>
                </div>

                <div class="template-section">
                    <div class="template-header">
                        Lower Extremity BioSleeves Alone - Intensity Set
                        <span class="edit-btn">Edit </span>
                    </div>
                    <div class="template-activities">
                        <div class="template-activity"
                            onclick="selectTemplateActivity(this, 'lower-extremity', 'Walking')">a. Walking</div>
                        <div class="template-activity"
                            onclick="selectTemplateActivity(this, 'lower-extremity', 'Jogging')">b. Jogging</div>
                        <div class="template-activity"
                            onclick="selectTemplateActivity(this, 'lower-extremity', 'Running')">c. Running</div>
                        <div class="template-activity"
                            onclick="selectTemplateActivity(this, 'lower-extremity', 'Stairs')">d. Stairs</div>
                        <div class="template-activity"
                            onclick="selectTemplateActivity(this, 'lower-extremity', 'Jumping')">e. Jumping</div>
                    </div>
                </div>

                <div class="template-section">
                    <div class="template-header">
                        BioShorts and Lower Extremity BioSleeves Combined
                    </div>
                    <div class="template-activities">
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'combined', 'Walking')">a.
                            Walking</div>
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'combined', 'Jogging')">b.
                            Jogging</div>
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'combined', 'Running')">c.
                            Running</div>
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'combined', 'Stairs')">d.
                            Stairs</div>
                        <div class="template-activity" onclick="selectTemplateActivity(this, 'combined', 'Jumping')">e.
                            Jumping</div>
                    </div>
                </div>

                <div class="template-section" style="border-color: transparent; box-shadow: none;">
                    <div class="template-duration">
                        <button class="duration-btn" onclick="selectDuration(this, '1h', 60, 2)">1 Hour Session (2 min
                            rest)</button>
                        <button class="duration-btn" onclick="selectDuration(this, '2h', 120, 5)">2 Hour Session (5 min
                            rest)</button>
                        <button class="duration-btn" onclick="selectDuration(this, '3h', 180, 10)">3 Hour Session (10
                            min rest)</button>
                        <button class="duration-btn" onclick="selectDuration(this, '8h', 480, 0)">8 Hour Overnight
                            Walking</button>
                    </div>
                </div>

                <button class="start-template-btn" onclick="startTemplate()">Start Template</button>
            </div>
        </div>


        <!-- SCREEN: EMG MONITOR -->
        <div id="screen-emg" class="screen">
            <div class="emg-container" style="padding:20px;overflow-y:auto;height:100%;">
                <div class="emg-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h2 style="margin:0;color:var(--text-primary);"> EMG Monitor</h2>
                    <div style="display:flex;gap:10px;">
                        <button class="settings-btn" onclick="toggleEMGRecording()" id="emg-record-btn"> Start Recording</button>
                        <button class="settings-btn" onclick="exportEMGData()"> Export Data</button>
                    </div>
                </div>
                
                <div class="emg-channels-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                    <!-- Channel 1 & 2 -->
                    <div class="emg-channel-card" style="background:var(--bg-card);padding:15px;border-radius:8px;box-shadow:var(--shadow);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                            <strong style="color:var(--text-primary);">CH 1-2: Quadriceps</strong>
                            <span id="emg-amp-1" style="color:var(--color-blue);font-size:12px;">0.0 mV</span>
                        </div>
                        <canvas id="emg-canvas-1" width="400" height="120" style="width:100%;height:120px;background:#1a1a1a;border-radius:4px;"></canvas>
                    </div>
                    
                    <!-- Channel 3 & 4 -->
                    <div class="emg-channel-card" style="background:var(--bg-card);padding:15px;border-radius:8px;box-shadow:var(--shadow);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                            <strong style="color:var(--text-primary);">CH 3-4: Glute-Ham</strong>
                            <span id="emg-amp-3" style="color:var(--color-blue);font-size:12px;">0.0 mV</span>
                        </div>
                        <canvas id="emg-canvas-3" width="400" height="120" style="width:100%;height:120px;background:#1a1a1a;border-radius:4px;"></canvas>
                    </div>
                    
                    <!-- Channel 5 & 6 -->
                    <div class="emg-channel-card" style="background:var(--bg-card);padding:15px;border-radius:8px;box-shadow:var(--shadow);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                            <strong style="color:var(--text-primary);">CH 5-6: Dorsiflexors</strong>
                            <span id="emg-amp-5" style="color:var(--color-blue);font-size:12px;">0.0 mV</span>
                        </div>
                        <canvas id="emg-canvas-5" width="400" height="120" style="width:100%;height:120px;background:#1a1a1a;border-radius:4px;"></canvas>
                    </div>
                    
                    <!-- Channel 7 & 8 -->
                    <div class="emg-channel-card" style="background:var(--bg-card);padding:15px;border-radius:8px;box-shadow:var(--shadow);">
                        <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                            <strong style="color:var(--text-primary);">CH 7-8: Plantar Flexors</strong>
                            <span id="emg-amp-7" style="color:var(--color-blue);font-size:12px;">0.0 mV</span>
                        </div>
                        <canvas id="emg-canvas-7" width="400" height="120" style="width:100%;height:120px;background:#1a1a1a;border-radius:4px;"></canvas>
                    </div>
                </div>
                
                <div class="emg-stats" style="margin-top:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
                    <div style="background:var(--bg-card);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;">Avg Amplitude</div>
                        <div id="emg-avg-amp" style="font-size:20px;font-weight:700;color:var(--color-blue);">0.0 mV</div>
                    </div>
                    <div style="background:var(--bg-card);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;">Peak Amplitude</div>
                        <div id="emg-peak-amp" style="font-size:20px;font-weight:700;color:var(--color-green-status);">0.0 mV</div>
                    </div>
                    <div style="background:var(--bg-card);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;">Frequency</div>
                        <div id="emg-frequency" style="font-size:20px;font-weight:700;color:var(--color-blue);">0 Hz</div>
                    </div>
                    <div style="background:var(--bg-card);padding:12px;border-radius:6px;text-align:center;">
                        <div style="font-size:11px;color:var(--text-secondary);text-transform:uppercase;">Recording Time</div>
                        <div id="emg-record-time" style="font-size:20px;font-weight:700;color:var(--text-primary);">00:00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-group nav-group-left">
                <span class="group-label">Navigation</span>
                <button class="nav-btn" onclick="goHome()"> Home</button>
                <button class="nav-btn" onclick="openModal('parameters')"> Parameters</button>
                <button class="nav-btn" onclick="switchScreen('usage', this)"> Usage</button>
                <button class="nav-btn" onclick="switchScreen('garment-overview', this)"> Garment</button>
            </div>
            <div class="nav-group-divider"></div>
            <div class="nav-group nav-group-right">
                <span class="group-label">Session Controls</span>
                <button class="nav-btn" onclick="resetAll()"> Reset</button>
                <button class="nav-btn" onclick="stopSession()"> Stop</button>
                <button class="nav-btn" onclick="saveSettings()"> Save</button>
                <button class="nav-btn" onclick="lockControls()"> Lock</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL (Complete) -->
    <div id="modal-settings" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('settings')"></button>
            <div class="modal-title"> SETTINGS</div>
            <button class="settings-btn" style="margin-bottom: 15px;" onclick="closeModal('settings')"> Back to Dashboard</button>

            <!-- General Settings -->
            <div class="settings-section">
                <div class="settings-section-title">General</div>

                <div class="setting-row">
                    <span class="setting-label">Notifications</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-labels">
                            <span>Off</span>
                            <span>On</span>
                        </div>
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Dark Mode</span>
                    <div class="toggle-switch" id="dark-mode-toggle" onclick="toggleDarkMode(this)">
                        <div class="toggle-labels">
                            <span>Off</span>
                            <span>On</span>
                        </div>
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Sound</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-labels">
                            <span>Off</span>
                            <span>On</span>
                        </div>
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Vibration</span>
                    <div class="toggle-switch active" onclick="toggleSwitch(this)">
                        <div class="toggle-labels">
                            <span>Off</span>
                            <span>On</span>
                        </div>
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Language</span>
                    <span class="setting-value">English</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Units</span>
                    <span class="setting-value">Metric</span>
                </div>
            </div>

            <!-- Device Settings -->
            <div class="settings-section">
                <div class="settings-section-title">Device</div>

                <div class="setting-row">
                    <span class="setting-label">Device ID</span>
                    <span class="setting-value">AX_to</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Firmware Version</span>
                    <span class="setting-value">v2.1.4</span>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Battery Saver Mode</span>
                    <div class="toggle-switch" onclick="toggleSwitch(this)">
                        <div class="toggle-labels">
                            <span>Off</span>
                            <span>On</span>
                        </div>
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Auto-Lock (min)</span>
                    <span class="setting-value">5</span>
                </div>
            </div>

            <!-- Network Settings -->
            <div class="settings-section">
                <div class="settings-section-title">Network</div>

                <div class="setting-row">
                    <span class="setting-label">Mesh Network Setup</span>
                    <button class="settings-btn" onclick="openNetworkSetup()">Configure</button>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Bluetooth</span>
                    <div class="toggle-switch active" onclick="toggleSwitch(this)">
                        <div class="toggle-labels">
                            <span>Off</span>
                            <span>On</span>
                        </div>
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">WiFi Status</span>
                    <span class="setting-value" style="color: var(--color-green-status);">Connected</span>
                </div>
            </div>

            <!-- Help & About -->
            <div class="settings-section">
                <div class="settings-section-title">Help & About</div>

                <div class="setting-row">
                    <span class="setting-label">User Guide</span>
                    <button class="settings-btn secondary" onclick="openUserGuide()">START </button>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Tutorial</span>
                    <button class="settings-btn secondary" onclick="openTutorial()">Watch</button>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Support</span>
                    <button class="settings-btn secondary">Contact</button>
                </div>

                <div class="setting-row">
                    <span class="setting-label">About NEURO PRO 2</span>
                    <button class="settings-btn secondary">Info</button>
                </div>
            </div>

            <!-- Data & Privacy -->
            <div class="settings-section">
                <div class="settings-section-title">Data & Privacy</div>

                <div class="setting-row">
                    <span class="setting-label">Data Sync</span>
                    <div class="toggle-switch active" onclick="toggleSwitch(this)">
                        <div class="toggle-labels">
                            <span>Off</span>
                            <span>On</span>
                        </div>
                        <div class="toggle-slider"></div>
                    </div>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Export Session Data</span>
                    <button class="settings-btn secondary">Export</button>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Clear Cache</span>
                    <button class="settings-btn secondary">Clear</button>
                </div>

                <div class="setting-row">
                    <span class="setting-label">Factory Reset</span>
                    <button class="settings-btn secondary"
                        style="color: var(--color-red-status); border-color: var(--color-red-status);">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NETWORK SETUP MODAL (Full Screen) -->
    <div id="modal-network" class="modal-overlay">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('network')"></button>
            <div class="modal-title"> Device & Network Setup</div>
            <button class="settings-btn" style="margin-bottom: 15px;" onclick="closeModal('network')"> Back</button>

            <div class="device-assignment">
                <div class="devices-grid">
                    <div class="device-card">
                        <button class="device-btn master selected">Device 1 - Master</button>
                        <button class="assign-btn assigned">Assigned</button>
                    </div>
                    <div class="device-card">
                        <button class="device-btn node">Device 3 - Node</button>
                        <button class="assign-btn">Assign</button>
                    </div>
                    <div class="device-card">
                        <button class="device-btn node selected">Device 2 - Node</button>
                        <button class="assign-btn">Assign</button>
                    </div>
                    <div class="device-card">
                        <button class="device-btn node">Device 4 - Node</button>
                        <button class="assign-btn">Assign</button>
                    </div>
                </div>

                <div class="network-tabs-container">
                    <div class="tab-headers">
                        <div class="tab-header active">Mesh Name</div>
                        <div class="tab-header">Mesh Password</div>
                        <div class="tab-header">WiFi Name</div>
                        <div class="tab-header">WiFi Password</div>
                    </div>

                    <div class="network-setup-title">Network Configuration</div>

                    <div class="network-form">
                        <div class="form-field">
                            <label class="form-label">Mesh Name</label>
                            <input type="text" class="form-input-box" placeholder="Enter mesh name">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Mesh Password</label>
                            <input type="password" class="form-input-box" placeholder="Enter password">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-input-box" placeholder="Confirm password">
                        </div>
                    </div>

                    <div class="network-form">
                        <div class="form-field">
                            <label class="form-label">WiFi Name (SSID)</label>
                            <input type="text" class="form-input-box" placeholder="Enter WiFi name">
                        </div>
                        <div class="form-field">
                            <label class="form-label">WiFi Password</label>
                            <input type="password" class="form-input-box" placeholder="Enter password">
                        </div>
                        <div class="form-field">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="form-input-box" placeholder="Confirm password">
                        </div>
                    </div>

                    <button class="save-btn" onclick="saveNetwork()">Save Network Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Parameters Modal -->
    <div id="modal-parameters" class="modal-overlay">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('parameters')"></button>
            <div class="modal-title"> Current Session Parameters</div>

            <!-- Session Duration -->
            <div class="params-section">
                <div class="params-section-title"> Session Configuration</div>
                <div class="param-row">
                    <div class="param-row-label">
                        Session Duration
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-session-duration" class="param-input editable" value="10" min="1"
                            max="480" step="1" onchange="updateSessionParameter('sessionDurationMin', this.value)">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">minutes</div>
                    </div>
                </div>
                <div class="param-row">
                    <div class="param-row-label">
                        Contraction Interval
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-contraction-interval" class="param-input editable" value="2"
                            min="1" max="30" step="1"
                            onchange="updateSessionParameter('contractionIntervalSec', this.value)">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">seconds</div>
                    </div>
                </div>
            </div>

            <!-- Cycle Timing Breakdown -->
            <div class="params-section">
                <div class="params-section-title"> Cycle Timing Breakdown</div>

                <div class="param-row">
                    <div class="param-row-label">
                        Ramp Up
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-ramp-up" class="param-input editable" value="3" min="0" max="30"
                            step="0.5" onchange="updateSessionParameter('rampUpSec', this.value)">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">seconds</div>
                    </div>
                </div>

                <div class="param-row">
                    <div class="param-row-label">
                        On / Hold (excl. ramp up/down)
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-hold-on" class="param-input editable" value="5" min="0" max="60"
                            step="0.5" onchange="updateSessionParameter('holdOnSec', this.value)">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">seconds</div>
                    </div>
                </div>

                <div class="param-row">
                    <div class="param-row-label">
                        Ramp Down (for eccentric work)
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-ramp-down" class="param-input editable" value="2" min="0"
                            max="30" step="0.5" onchange="updateSessionParameter('rampDownSec', this.value)">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">seconds</div>
                    </div>
                </div>

                <div class="param-row">
                    <div class="param-row-label">
                        Off (rest period)
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-off" class="param-input editable" value="5" min="0" max="60"
                            step="0.5" onchange="updateSessionParameter('offSec', this.value)">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">seconds</div>
                    </div>
                </div>

                <div class="param-row">
                    <div class="param-row-label">
                        Total Cycle Time
                    </div>
                    <div class="param-row-value">
                        <input type="text" id="param-total-cycle" class="param-input readonly" value="15.0 sec"
                            readonly>
                    </div>
                </div>

                <div class="param-note">
                     <strong>Note:</strong> On time = hold phase only. Ramp up and ramp down are separate phases.
                    Total cycle = Ramp Up + Hold + Ramp Down + Off.
                </div>
            </div>

            <!-- EMS Settings -->
            <div class="params-section">
                <div class="params-section-title"> EMS Stimulation Settings</div>

                <div class="param-row">
                    <div class="param-row-label">
                        Mode
                    </div>
                    <div class="param-row-value">
                        <select id="param-mode" class="param-select"
                            onchange="updateSessionParameter('mode', this.value)">
                            <option value="GAIT">GAIT</option>
                            <option value="EMS All">EMS All</option>
                            <option value="NMES">NMES</option>
                            <option value="Custom">Custom</option>
                        </select>
                    </div>
                </div>

                <div class="param-row">
                    <div class="param-row-label">
                        Frequency
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-frequency" class="param-input editable" value="25" min="1"
                            max="100" step="1" onchange="updateSessionParameter('frequencyHz', this.value)">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Hz</div>
                    </div>
                </div>

                <div class="param-row">
                    <div class="param-row-label">
                        Pulse Width
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-pulse-width" class="param-input editable" value="400" min="50"
                            max="1000" step="50" onchange="updateSessionParameter('pulseWidthUs', this.value)">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">s</div>
                    </div>
                </div>

                <div class="param-row">
                    <div class="param-row-label">
                        Stimulation Pattern
                    </div>
                    <div class="param-row-value">
                        <select id="param-pattern" class="param-select"
                            onchange="updateSessionParameter('pattern', this.value)">
                            <option value="Synchronous">Synchronous</option>
                            <option value="Asynchronous">Asynchronous</option>
                        </select>
                    </div>
                </div>

                <!-- Admin Only: Maximum Power -->
                <div class="param-row" id="param-max-power-row" style="display: none;">
                    <div class="param-row-label">
                        Maximum Power (Admin Only)
                        <span style="font-size: 11px; color: var(--color-red-status); font-weight: 700;"> 
                            RESTRICTED</span>
                    </div>
                    <div class="param-row-value">
                        <input type="number" id="param-max-power" class="param-input editable" value="100" min="0"
                            max="200" step="5" onchange="updateSessionParameter('maxPowerPercent', this.value)"
                            style="border-color: var(--color-red-status);">
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">% (up to 200%)
                        </div>
                    </div>
                </div>
            </div> <!-- Display Preferences -->
            <div class="params-section">
                <div class="params-section-title"> Display Preferences</div>

                <div class="param-row">
                    <div class="param-row-label">
                        Channel Display Unit
                    </div>
                    <div class="param-row-value">
                        <select id="param-display-unit" class="param-select"
                            onchange="updateSessionParameter('displayUnit', this.value)">
                            <option value="Voltage">Voltage (V)</option>
                            <option value="Charge">Charge per Pulse (C)</option>
                            <option value="Intensity">Intensity (%)</option>
                            <option value="Current">Current (mA)</option>
                        </select>
                    </div>
                </div>

                <div class="param-note">
                     <strong>Display only</strong>  changing this unit does not affect therapy settings.
                    It only changes how channel values are shown on the dashboard.
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="params-actions">
                <button class="params-reset-btn" onclick="resetParametersToDefault()"> Reset to Default</button>
                <button class="params-save-btn" onclick="saveParameters()"> Save Parameters</button>
            </div>
        </div>
    </div>

    <!-- USER GUIDE MODAL -->
    <div id="modal-user-guide" class="modal-overlay">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('user-guide')"></button>
            <div class="modal-title"> User Guide</div>

            <div class="guide-container">
                <!-- Progress Indicator -->
                <div class="guide-progress">
                    <span id="guide-step-number">Step 1 of 7</span>
                </div>

                <!-- Step Content -->
                <div class="guide-step active" id="guide-step-1">
                    <div class="guide-icon"></div>
                    <h2 class="guide-step-title">Welcome to NEURO PRO 2</h2>
                    <div class="guide-step-content">
                        <p>This interactive guide will walk you through all essential features of your NEURO PRO 2
                            device.</p>
                        <p><strong>What you'll learn:</strong></p>
                        <ul>
                            <li> Basic safety information</li>
                            <li> Electrode placement</li>
                            <li> Adjusting intensity levels</li>
                            <li> Using templates</li>
                            <li> Network setup</li>
                            <li> Troubleshooting common issues</li>
                        </ul>
                        <p class="guide-note"> Estimated time: 5-7 minutes</p>
                    </div>
                </div>

                <div class="guide-step" id="guide-step-2">
                    <div class="guide-icon"></div>
                    <h2 class="guide-step-title">Safety First</h2>
                    <div class="guide-step-content">
                        <p><strong>Before starting therapy, please read these important safety warnings:</strong></p>
                        <div class="warning-box">
                            <p> <strong>DO NOT use if you have:</strong></p>
                            <ul>
                                <li>Pacemaker or implanted defibrillator</li>
                                <li>Pregnancy</li>
                                <li>Epilepsy or seizure disorders</li>
                                <li>Open wounds or skin conditions in treatment area</li>
                            </ul>
                        </div>
                        <div class="info-box">
                            <p> <strong>Always ensure:</strong></p>
                            <ul>
                                <li>Electrodes are properly attached to skin</li>
                                <li>Battery is charged above 20%</li>
                                <li>You can easily stop therapy at any time</li>
                                <li>Start with low intensity and gradually increase</li>
                            </ul>
                        </div>
                        <p><em>Consult your healthcare provider if you have any concerns.</em></p>
                    </div>
                </div>

                <div class="guide-step" id="guide-step-3">
                    <div class="guide-icon"></div>
                    <h2 class="guide-step-title">Electrode Placement</h2>
                    <div class="guide-step-content">
                        <p><strong>Proper electrode placement is critical for effective therapy:</strong></p>

                        <div class="electrode-demo">
                            <div class="electrode-group">
                                <h3>BioShorts (Channels 1-4)</h3>
                                <ul>
                                    <li><span class="ch-indicator pink">CH 1-2</span> Left Quadriceps & Glutes</li>
                                    <li><span class="ch-indicator green">CH 3-4</span> Right Quadriceps & Glutes</li>
                                </ul>
                            </div>

                            <div class="electrode-group">
                                <h3>BioSleeves (Channels 5-8)</h3>
                                <ul>
                                    <li><span class="ch-indicator purple">CH 5-6</span> Left Dorsi/Plantar Flexors</li>
                                    <li><span class="ch-indicator orange">CH 7-8</span> Right Dorsi/Plantar Flexors</li>
                                </ul>
                            </div>
                        </div>

                        <div class="info-box">
                            <p><strong>Tips for best results:</strong></p>
                            <ul>
                                <li>Clean and dry skin before application</li>
                                <li>Ensure firm contact with no air bubbles</li>
                                <li>Replace electrodes every 20-30 uses</li>
                                <li>Check battery level on each channel ()</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="guide-step" id="guide-step-4">
                    <div class="guide-icon"></div>
                    <h2 class="guide-step-title">Adjusting Intensity</h2>
                    <div class="guide-step-content">
                        <p><strong>Learn how to safely adjust stimulation intensity:</strong></p>

                        <div class="demo-box">
                            <h3>Dashboard Controls</h3>
                            <p>Each channel card has <strong>+</strong> and <strong></strong> buttons:</p>
                            <div class="button-demo">
                                <button class="demo-btn-plus">+</button> Increase by 1%
                                <button class="demo-btn-minus"></button> Decrease by 1%
                            </div>
                            <p class="intensity-display-demo">Current: <strong>45%</strong></p>
                        </div>

                        <div class="info-box">
                            <p><strong>Best practices:</strong></p>
                            <ul>
                                <li>Start at 0% and gradually increase</li>
                                <li>Find your "comfortable strong" level</li>
                                <li>Typical range: 40-70% for most activities</li>
                                <li>Never exceed your pain tolerance</li>
                                <li>Use <strong>RESET</strong> button to zero all channels</li>
                            </ul>
                        </div>

                        <div class="warning-box">
                            <p> If you feel sharp pain or discomfort, <strong>immediately reduce intensity or
                                    stop</strong>.</p>
                        </div>
                    </div>
                </div>

                <div class="guide-step" id="guide-step-5">
                    <div class="guide-icon"></div>
                    <h2 class="guide-step-title">Using Templates</h2>
                    <div class="guide-step-content">
                        <p><strong>Templates provide pre-configured intensity settings for different
                                activities:</strong></p>

                        <div class="template-demo">
                            <h3>Available Templates</h3>
                            <div class="template-list">
                                <div class="template-item">
                                    <span class="template-icon"></span>
                                    <strong>Walking</strong> - Gentle support (40-45%)
                                </div>
                                <div class="template-item">
                                    <span class="template-icon"></span>
                                    <strong>Jogging</strong> - Moderate intensity (55-60%)
                                </div>
                                <div class="template-item">
                                    <span class="template-icon"></span>
                                    <strong>Running</strong> - High intensity (70-75%)
                                </div>
                                <div class="template-item">
                                    <span class="template-icon"></span>
                                    <strong>Stairs</strong> - Full body (60-65% + calves)
                                </div>
                                <div class="template-item">
                                    <span class="template-icon"></span>
                                    <strong>Jumping</strong> - Maximum support (75-80%)
                                </div>
                            </div>
                        </div>

                        <div class="demo-box">
                            <h3>How to Apply a Template</h3>
                            <ol>
                                <li>Click the <strong>Templates</strong> dropdown in the header</li>
                                <li>Select your activity (e.g., "Walking")</li>
                                <li>All channel intensities update automatically</li>
                                <li>Fine-tune individual channels as needed</li>
                            </ol>
                        </div>

                        <p><em>Tip: You can modify templates and save custom settings via the Garment Setup screen.</em>
                        </p>
                    </div>
                </div>

                <div class="guide-step" id="guide-step-6">
                    <div class="guide-icon"></div>
                    <h2 class="guide-step-title">Network Setup</h2>
                    <div class="guide-step-content">
                        <p><strong>Configure mesh network and WiFi for multi-device setups:</strong></p>

                        <div class="info-box">
                            <p><strong>When to use Mesh Network:</strong></p>
                            <ul>
                                <li>Using 2+ NEURO PRO 2 devices simultaneously</li>
                                <li>Need synchronized stimulation across multiple garments</li>
                                <li>Want centralized control of all devices</li>
                            </ul>
                        </div>

                        <div class="demo-box">
                            <h3>Setup Steps</h3>
                            <ol>
                                <li>Click <strong> Settings</strong>  Network section</li>
                                <li>Click <strong>"Configure"</strong> next to Mesh Network Setup</li>
                                <li>Assign <strong>Master</strong> device (main controller)</li>
                                <li>Assign <strong>Node</strong> devices (secondary units)</li>
                                <li>Enter Mesh Name and Password</li>
                                <li>Enter WiFi credentials for cloud sync</li>
                                <li>Click <strong>"Save Network Settings"</strong></li>
                            </ol>
                        </div>

                        <div class="device-role-demo">
                            <div class="role-card master-role">
                                <strong>Master Device</strong>
                                <p>Sends commands to all nodes</p>
                            </div>
                            <div class="role-card node-role">
                                <strong>Node Devices</strong>
                                <p>Receive commands, execute stimulation</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="guide-step" id="guide-step-7">
                    <div class="guide-icon"></div>
                    <h2 class="guide-step-title">Troubleshooting</h2>
                    <div class="guide-step-content">
                        <p><strong>Common issues and quick solutions:</strong></p>

                        <div class="troubleshooting-item">
                            <h4> No stimulation on a channel</h4>
                            <ul>
                                <li>Check electrode connection</li>
                                <li>Verify battery level ( should be >20%)</li>
                                <li>Ensure intensity is above 0%</li>
                                <li>Check resistance reading (R: should be <5000 )</li>
                            </ul>
                        </div>

                        <div class="troubleshooting-item">
                            <h4> Uncomfortable or painful sensation</h4>
                            <ul>
                                <li>Reduce intensity immediately</li>
                                <li>Check for air bubbles under electrodes</li>
                                <li>Ensure electrodes are placed on muscle, not bone</li>
                                <li>Replace old/dry electrodes</li>
                            </ul>
                        </div>

                        <div class="troubleshooting-item">
                            <h4> Device won't connect to WiFi</h4>
                            <ul>
                                <li>Verify WiFi password is correct</li>
                                <li>Ensure 2.4GHz network (5GHz not supported)</li>
                                <li>Move closer to router</li>
                                <li>Restart device and try again</li>
                            </ul>
                        </div>

                        <div class="troubleshooting-item">
                            <h4> Battery drains quickly</h4>
                            <ul>
                                <li>Enable Battery Saver Mode (Settings  Device)</li>
                                <li>Disable WiFi/Bluetooth when not needed</li>
                                <li>Reduce screen brightness</li>
                                <li>Close unused background apps</li>
                            </ul>
                        </div>

                        <div class="support-box">
                            <p><strong>Still need help?</strong></p>
                            <p>Settings  Help & About  <strong>Support</strong></p>
                            <p>24/7 Live Chat  Email  Phone: 1-800-AXIO-PRO</p>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="guide-navigation">
                    <button class="guide-nav-btn" id="guide-prev-btn" onclick="previousGuideStep()" disabled>
                        Previous</button>
                    <button class="guide-nav-btn primary" id="guide-next-btn" onclick="nextGuideStep()">Next </button>
                    <button class="guide-nav-btn primary" id="guide-finish-btn" onclick="closeModal('user-guide')"
                        style="display: none;">Finish </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TUTORIAL MODAL -->
    <div id="modal-tutorial" class="modal-overlay">
        <div class="modal-content large">
            <button class="modal-close" onclick="closeModal('tutorial')"></button>
            <div class="modal-title"> Interactive Tutorials</div>

            <div class="tutorial-container">
                <!-- Tutorial Tabs -->
                <div class="tutorial-tabs">
                    <button class="tutorial-tab active" onclick="switchTutorial(1, this)">First-Time Setup</button>
                    <button class="tutorial-tab" onclick="switchTutorial(2, this)">Garment Pairing</button>
                    <button class="tutorial-tab" onclick="switchTutorial(3, this)">Creating Templates</button>
                    <button class="tutorial-tab" onclick="switchTutorial(4, this)">Network Config</button>
                </div>

                <!-- Tutorial 1: First-Time Setup -->
                <div class="tutorial-content active" id="tutorial-1">
                    <div class="tutorial-header">
                        <h2>First-Time Setup</h2>
                        <span class="tutorial-duration"> 5 minutes</span>
                    </div>

                    <div class="video-player-demo">
                        <div class="video-placeholder">
                            <div class="play-button-large"></div>
                            <p>Video Tutorial: Getting Started with NEURO PRO 2</p>
                        </div>
                    </div>

                    <div class="tutorial-steps">
                        <h3>Step-by-Step Instructions</h3>

                        <div class="tutorial-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Unbox and Charge</h4>
                                <p>Remove device from packaging. Connect charging cable and charge until  shows 100%
                                    (approximately 2 hours).</p>
                                <div class="step-highlight"> Battery indicator turns green when fully charged</div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Power On</h4>
                                <p>Press and hold power button for 3 seconds. You'll see the NEURO PRO 2 splash screen.
                                </p>
                                <div class="step-highlight"> Device vibrates once when powered on</div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Initial Configuration</h4>
                                <p>Follow on-screen prompts to select:</p>
                                <ul>
                                    <li>Language preference</li>
                                    <li>Units (Metric/Imperial)</li>
                                    <li>Time zone</li>
                                </ul>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Connect Garments</h4>
                                <p>Navigate to <strong>GARMENT</strong> screen. Press pairing button on
                                    BioShorts/BioSleeves. Device will automatically detect and connect.</p>
                                <div class="step-highlight"> Green checkmark appears when paired successfully</div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h4>Test Channels</h4>
                                <p>On Dashboard, press <strong>+</strong> button on each channel to verify stimulation.
                                    Start with low intensity (20-30%).</p>
                                <div class="step-highlight"> You should feel a tingling sensation, not pain</div>
                            </div>
                        </div>

                        <div class="tutorial-step completed">
                            <div class="step-number"></div>
                            <div class="step-content">
                                <h4>You're Ready!</h4>
                                <p>Your NEURO PRO 2 is now configured and ready for therapy sessions.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tutorial 2: Garment Pairing -->
                <div class="tutorial-content" id="tutorial-2">
                    <div class="tutorial-header">
                        <h2>Garment Pairing</h2>
                        <span class="tutorial-duration"> 3 minutes</span>
                    </div>

                    <div class="video-player-demo">
                        <div class="video-placeholder">
                            <div class="play-button-large"></div>
                            <p>Video Tutorial: Pairing BioShorts and BioSleeves</p>
                        </div>
                    </div>

                    <div class="tutorial-steps">
                        <h3>Pairing Process</h3>

                        <div class="tutorial-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Navigate to Garment Setup</h4>
                                <p>Click <strong>GARMENT</strong> button in bottom navigation. You'll see the Garment
                                    Setup Overview screen.</p>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Select Garment Type</h4>
                                <p>Choose which garment to pair:</p>
                                <div class="garment-options">
                                    <div class="option-card">
                                        <strong>BioShorts</strong>
                                        <p>Channels 1-4</p>
                                        <p>Quadriceps & Glutes</p>
                                    </div>
                                    <div class="option-card">
                                        <strong>BioSleeves</strong>
                                        <p>Channels 5-8</p>
                                        <p>Calf muscles</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Activate Pairing Mode</h4>
                                <p>On the garment, press and hold the Bluetooth button for 5 seconds until LED flashes
                                    blue rapidly.</p>
                                <div class="step-highlight"> LED will flash every 2 seconds in pairing mode</div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Confirm Connection</h4>
                                <p>Device will automatically detect the garment. You'll see:</p>
                                <ul>
                                    <li>Device name appear on screen</li>
                                    <li>Battery level for each channel</li>
                                    <li>Green "Connected" status</li>
                                </ul>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h4>Test Connection</h4>
                                <p>Click "Test" button for each activity (Walking, Jogging, etc.) to verify all channels
                                    respond correctly.</p>
                                <div class="step-highlight"> Each channel should show stimulation when tested</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tutorial 3: Creating Templates -->
                <div class="tutorial-content" id="tutorial-3">
                    <div class="tutorial-header">
                        <h2>Creating Custom Templates</h2>
                        <span class="tutorial-duration"> 4 minutes</span>
                    </div>

                    <div class="video-player-demo">
                        <div class="video-placeholder">
                            <div class="play-button-large"></div>
                            <p>Video Tutorial: Custom Template Creation</p>
                        </div>
                    </div>

                    <div class="tutorial-steps">
                        <h3>Creating Your Custom Template</h3>

                        <div class="tutorial-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Go to Garment Detail Screen</h4>
                                <p>Navigate to <strong>GARMENT</strong>  Click "Click to set intensity for BioShorts"
                                    or "BioSleeves".</p>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Select Activity</h4>
                                <p>Choose which activity you want to configure (Walking, Jogging, Running, Stairs, or
                                    Jumping).</p>
                                <div class="activity-selector-demo">
                                    <div class="activity-option"> Walking</div>
                                    <div class="activity-option"> Jogging</div>
                                    <div class="activity-option"> Running</div>
                                </div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Adjust Channel Intensities</h4>
                                <p>Use the <strong>+</strong> and <strong></strong> buttons on each channel card to set
                                    desired intensity levels.</p>
                                <div class="intensity-guide">
                                    <p><strong>Recommended ranges:</strong></p>
                                    <ul>
                                        <li>Walking: 35-50%</li>
                                        <li>Jogging: 50-65%</li>
                                        <li>Running: 65-80%</li>
                                        <li>Stairs: 55-70%</li>
                                        <li>Jumping: 70-85%</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Test Your Settings</h4>
                                <p>Click the <strong>"Test"</strong> button next to the activity. Device will apply the
                                    intensities and run for 10 seconds.</p>
                                <div class="step-highlight"> Make sure you're in a safe position to receive
                                    stimulation</div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h4>Save Template</h4>
                                <p>If the intensities feel good, click <strong>"Save"</strong> button. Your custom
                                    template is now stored and can be accessed from the Templates dropdown.</p>
                                <div class="step-highlight"> Template saved successfully!</div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">6</div>
                            <div class="step-content">
                                <h4>Apply Your Template</h4>
                                <p>Return to Dashboard. Click <strong>Templates</strong> dropdown in header and select
                                    your saved activity. All channels will update automatically.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tutorial 4: Network Configuration -->
                <div class="tutorial-content" id="tutorial-4">
                    <div class="tutorial-header">
                        <h2>Network Configuration</h2>
                        <span class="tutorial-duration"> 6 minutes</span>
                    </div>

                    <div class="video-player-demo">
                        <div class="video-placeholder">
                            <div class="play-button-large"></div>
                            <p>Video Tutorial: Multi-Device Mesh Setup</p>
                        </div>
                    </div>

                    <div class="tutorial-steps">
                        <h3>Setting Up Mesh Network</h3>

                        <div class="tutorial-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Open Network Settings</h4>
                                <p>Click <strong> Settings</strong>  Scroll to <strong>Network</strong> section 
                                    Click <strong>"Configure"</strong> button next to "Mesh Network Setup".</p>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Assign Master Device</h4>
                                <p>The first device (usually the one you're holding) should be set as
                                    <strong>Master</strong>. This device controls all others.
                                </p>
                                <div class="device-assignment-demo">
                                    <div class="device-card-demo master">
                                        <strong>Device 1 - Master</strong>
                                        <span class="status-badge assigned">Assigned</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Assign Node Devices</h4>
                                <p>Click <strong>"Assign"</strong> button for each additional device (Devices 2, 3, 4).
                                    These become Nodes that receive commands from the Master.</p>
                                <div class="node-grid-demo">
                                    <div class="device-card-demo node">Device 2 - Node</div>
                                    <div class="device-card-demo node">Device 3 - Node</div>
                                    <div class="device-card-demo node">Device 4 - Node</div>
                                </div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Configure Mesh Credentials</h4>
                                <p>Enter your mesh network settings:</p>
                                <div class="form-demo">
                                    <div class="form-row-demo">
                                        <label>Mesh Name:</label>
                                        <input type="text" placeholder="MyNeuroPro2Mesh" disabled>
                                    </div>
                                    <div class="form-row-demo">
                                        <label>Mesh Password:</label>
                                        <input type="password" placeholder="" disabled>
                                    </div>
                                </div>
                                <div class="step-highlight"> Use a strong password (8+ characters)</div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h4>Configure WiFi</h4>
                                <p>Enter your WiFi credentials for cloud sync and firmware updates:</p>
                                <div class="form-demo">
                                    <div class="form-row-demo">
                                        <label>WiFi Name (SSID):</label>
                                        <input type="text" placeholder="HomeWiFi" disabled>
                                    </div>
                                    <div class="form-row-demo">
                                        <label>WiFi Password:</label>
                                        <input type="password" placeholder="" disabled>
                                    </div>
                                </div>
                                <div class="step-highlight"> Only 2.4GHz networks are supported</div>
                            </div>
                        </div>

                        <div class="tutorial-step">
                            <div class="step-number">6</div>
                            <div class="step-content">
                                <h4>Save and Test</h4>
                                <p>Click <strong>"Save Network Settings"</strong> button. Wait 10-15 seconds for all
                                    devices to connect.</p>
                                <div class="step-highlight"> All devices show "Connected" status when successful</div>
                            </div>
                        </div>

                        <div class="tutorial-step completed">
                            <div class="step-number"></div>
                            <div class="step-content">
                                <h4>Mesh Network Active!</h4>
                                <p>You can now control all connected devices from the Master device. Intensity changes,
                                    templates, and commands will synchronize across all nodes.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const channels = [
            { id: 1, muscle: 'Left Quadricep', intensity: 0 },
            { id: 2, muscle: 'Left Glute-Ham', intensity: 0 },
            { id: 3, muscle: 'Right Quadricep', intensity: 0 },
            { id: 4, muscle: 'Right Glute-Ham', intensity: 0 },
            { id: 5, muscle: 'Left Dorsiflexors', intensity: 0 },
            { id: 6, muscle: 'Left Plantar Flexors', intensity: 0 },
            { id: 7, muscle: 'Right Dorsiflexors', intensity: 0 },
            { id: 8, muscle: 'Right Plantar Flexors', intensity: 0 }
        ];

        // Per-channel active seconds accumulator for progress bars
        let channelActiveSeconds = new Array(channels.length).fill(0);

        // Reusable AudioContext for button sound effects
        let np2AudioCtx = null;
        function playAdjustmentSound(delta) {
            try {
                if (!np2AudioCtx) np2AudioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const ctx = np2AudioCtx;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                // Higher pitch for increment, lower for decrement
                osc.type = 'sine';
                osc.frequency.value = delta > 0 ? 880 : 440;
                gain.gain.setValueAtTime(0.0001, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime + 0.015);
                gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
                osc.connect(gain).connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 0.18);
            } catch (e) {
                // Fail silently if AudioContext not available
            }
        }

        let sessionTime = 0;
        let contractionCount = 0;
        let sessionActive = false;
        let sessionInterval = null;
        let sessionDuration = 10 * 60; // 10 minutes in seconds (configurable)
        let selectedTemplate = null;
        let selectedDuration = null; // { code, minutes, restMinutes }
        let anyActiveSeconds = 0; // Seconds where at least one channel active

        // Session Parameters (editable)
        let sessionParams = {
            // Session timing
            sessionDurationMin: 10,
            contractionIntervalSec: 2,

            // Cycle timing breakdown
            rampUpSec: 3,
            holdOnSec: 5,      // On/Hold time (excludes ramp up/down)
            rampDownSec: 2,
            offSec: 5,

            // EMS settings
            mode: 'GAIT',
            frequencyHz: 25,
            pulseWidthUs: 400,

            // Stimulation pattern
            pattern: 'Synchronous',  // 'Synchronous' or 'Asynchronous'

            // Display preferences
            displayUnit: 'Voltage',  // 'Voltage' or 'Charge'

            // Admin only
            maxPowerPercent: 100  // Default 100%, admins can go up to 200%
        };

        // Login handler
        function handleLogin(event) {
            event.preventDefault();

            const name = document.getElementById('login-name').value;
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const role = document.getElementById('login-role').value;
            const plan = document.getElementById('login-plan').value;

            // Store user data (Note: In production, never store passwords in localStorage)
            const userData = {
                loggedIn: true,
                name: name,
                email: email,
                role: role,
                plan: plan,
                loginTime: new Date().toISOString()
            };
            localStorage.setItem('np2-user', JSON.stringify(userData));

            // Update UI with user name
            updateUserDisplay(userData);

            // Hide login, show splash
            document.getElementById('login').classList.add('hidden');
            document.getElementById('splash').classList.remove('hidden');

            // After splash, show main app
            setTimeout(() => {
                document.getElementById('splash').classList.add('hidden');
                document.getElementById('app').style.display = 'block';
            }, 2500);
        }

        // Update user display and admin features
        function updateUserDisplay(userData) {
            const nameDisplay = document.getElementById('user-name-display');
            if (nameDisplay && userData.name) {
                nameDisplay.textContent = ` ${userData.name} (${userData.role})`;
            }

            // Show admin-only controls if user is Administrator
            if (userData.role === 'Administrator') {
                const maxPowerRow = document.getElementById('param-max-power-row');
                if (maxPowerRow) {
                    maxPowerRow.style.display = 'flex';
                }
            }
        }

        // Check if already logged in
        function checkLoginStatus() {
            const userData = localStorage.getItem('np2-user');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.loggedIn) {
                        // Update user display
                        updateUserDisplay(user);

                        // Skip login, go straight to splash then app
                        document.getElementById('login').classList.add('hidden');
                        document.getElementById('splash').classList.remove('hidden');
                        setTimeout(() => {
                            document.getElementById('splash').classList.add('hidden');
                            document.getElementById('app').style.display = 'block';
                        }, 2500);
                        return true;
                    }
                } catch (e) {
                    console.warn('Failed to parse user data:', e);
                }
            }
            return false;
        }

        // Run on page load
        checkLoginStatus();

        // Screen navigation
        function switchScreen(screenName, buttonEl) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenName).classList.add('active');

            if (buttonEl) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                buttonEl.classList.add('active');
            }

            // Defensive re-render for usage chart when navigating to usage screen
            if (screenName === 'usage') {
                // Always attempt a refresh (period retained in currentUsagePeriod)
                if (typeof renderUsageChart === 'function') {
                    try {
                        renderUsageChart(currentUsagePeriod || 'weekly');
                    } catch (e) {
                        console.warn('[UsageChart] renderUsageChart threw, retrying after delay', e);
                        setTimeout(() => {
                            try { renderUsageChart(currentUsagePeriod || 'weekly'); } catch (_) { /* noop */ }
                        }, 100);
                    }
                }
                // Ensure bars actually exist; if not, force a weekly render
                setTimeout(() => {
                    if (typeof ensureUsageChartVisible === 'function') {
                        ensureUsageChartVisible();
                    }
                }, 50);
            }
        }

        function goHome() {
            switchScreen('dashboard', document.querySelector('.nav-btn'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
        }

        // Mode switching
        let currentMode = 'manual'; // 'manual' or 'template'

        function switchToMode(mode, buttonEl) {
            currentMode = mode;

            // Update active button
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            if (buttonEl) {
                buttonEl.classList.add('active');
            }

            // Update mode indicator
            const modeIndicator = document.getElementById('mode-indicator');
            const templateSelector = document.getElementById('template-selector-container');
            const channelControls = document.querySelectorAll('.channel-controls');

            if (mode === 'manual') {
                // Manual mode: Show controls, hide template selector
                modeIndicator.textContent = 'MANUAL MODE';
                modeIndicator.style.background = 'var(--color-blue)';
                templateSelector.style.display = 'none';

                // Enable channel controls
                channelControls.forEach(ctrl => {
                    ctrl.style.pointerEvents = 'auto';
                    ctrl.style.opacity = '1';
                });

                // Switch to dashboard
                switchScreen('dashboard', null);

            } else if (mode === 'template') {
                // Template mode: Hide manual controls, show template selector
                modeIndicator.textContent = 'TEMPLATE MODE';
                modeIndicator.style.background = 'var(--color-purple)';
                templateSelector.style.display = 'flex';
                templateSelector.style.alignItems = 'center';

                // Disable channel manual controls
                channelControls.forEach(ctrl => {
                    ctrl.style.pointerEvents = 'none';
                    ctrl.style.opacity = '0.4';
                });

                // Switch to templates screen
                switchScreen('templates', null);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('np2-user');
                location.reload();
            }
        }

        // Render channels
        function renderChannels() {
            const container = document.getElementById('channels-grid');
            container.innerHTML = channels.map(ch => `
                <div class="channel-card ch-${ch.id}">
                    <div class="channel-number">${ch.id}</div>
                    <div class="channel-battery"> 100%</div>
                    <div>
                        <span class="channel-intensity" id="ch${ch.id}-value">${ch.intensity}</span>
                        <span style="font-size: 18px;">%</span>
                    </div>
                    <div class="channel-stats">
                        <div>0.0 V</div>
                        <div>R: 0 </div>
                    </div>
                    <div class="channel-muscle">${ch.muscle}</div>
                    <div class="channel-controls">
                        <button class="channel-btn" onclick="adjustChannel(${ch.id}, -1)"></button>
                        <button class="channel-btn" onclick="adjustChannel(${ch.id}, 1)">+</button>
                    </div>
                    <div class="channel-progress-wrapper">
                        <div class="channel-progress-bar" id="ch${ch.id}-progress"></div>
                        <div class="channel-progress-label" id="ch${ch.id}-progress-label">0%</div>
                    </div>
                </div>
            `).join('');
        }

        function adjustChannel(channelId, delta) {
            const channel = channels[channelId - 1];
            const newIntensity = Math.max(0, Math.min(100, channel.intensity + delta));
            channel.intensity = newIntensity;

            const valueEl = document.getElementById(`ch${channelId}-value`);
            if (valueEl) {
                valueEl.textContent = newIntensity;
                valueEl.style.color = delta > 0 ? 'var(--color-green-status)' : 'var(--color-red-status)';
                setTimeout(() => valueEl.style.color = '', 200);
            }

            // Play sound feedback
            playAdjustmentSound(delta);

            // Update active highlighting
            updateActiveHighlights();
        }

        function resetAll() {
            if (confirm('Reset all settings? This will stop the session and reset all channels, timer, and contractions.')) {
                // Stop session
                stopSession();

                // Reset channels
                channels.forEach((ch, idx) => {
                    ch.intensity = 0;
                    const valueEl = document.getElementById(`ch${idx + 1}-value`);
                    if (valueEl) valueEl.textContent = '0';
                });

                // Reset timer and contractions
                sessionTime = 0;
                contractionCount = 0;
                document.getElementById('timer').textContent = '00:00';
                document.getElementById('contraction-count').textContent = '0';
                anyActiveSeconds = 0;
                channelActiveSeconds = new Array(channels.length).fill(0);
                updateChannelProgress();
                updateActiveSummary();
                updateTimerDisplay(); // Reset remaining time display

                // Clear selected template
                selectedTemplate = null;
                document.querySelectorAll('.template-activity').forEach(t => t.classList.remove('selected'));

                updateActiveHighlights();
            }
        }

        // Highlight logic: any channel with intensity >0 marks its card active; detail cards active if any child channel >0
        function updateActiveHighlights() {
            // Grid cards
            channels.forEach(ch => {
                const card = document.querySelector(`.channel-card.ch-${ch.id}`);
                if (card) {
                    if (ch.intensity > 0) card.classList.add('active'); else card.classList.remove('active');
                }
            });
            // Detail cards mapping
            const groups = [[1, 2], [3, 4], [5, 6], [7, 8]];
            const detailCards = document.querySelectorAll('.detail-channel-card');
            groups.forEach((arr, idx) => {
                const anyActive = arr.some(id => channels[id - 1].intensity > 0);
                const card = detailCards[idx];
                if (card) {
                    if (anyActive) card.classList.add('active'); else card.classList.remove('active');
                }
            });
        }

        // Update per-channel progress bars relative to total session duration
        function updateChannelProgress() {
            const total = sessionDuration > 0 ? sessionDuration : 1;
            channelActiveSeconds.forEach((secs, idx) => {
                const bar = document.getElementById(`ch${idx + 1}-progress`);
                const label = document.getElementById(`ch${idx + 1}-progress-label`);
                if (bar) {
                    const pct = Math.min(100, (secs / total) * 100);
                    bar.style.width = pct.toFixed(2) + '%';
                    if (label) label.textContent = pct.toFixed(0) + '%';
                }
            });
        }

        function updateActiveSummary() {
            const anyEl = document.getElementById('active-time-any');
            const utilEl = document.getElementById('active-utilization');
            if (anyEl) anyEl.textContent = anyActiveSeconds + 's';
            if (utilEl) {
                const pct = sessionTime > 0 ? (anyActiveSeconds / sessionTime) * 100 : 0;
                utilEl.textContent = pct.toFixed(1) + '%';
            }
        }

        function exportChannelUsageCSV() {
            const headers = ['Channel', 'Muscle', 'ActiveSeconds', 'ActivePercentOfSession', 'FinalIntensity'];
            const total = sessionDuration > 0 ? sessionDuration : 1;
            const rows = channels.map((ch, idx) => {
                const activeSecs = channelActiveSeconds[idx];
                const pct = (activeSecs / total) * 100;
                return [ch.id, ch.muscle, activeSecs, pct.toFixed(2), ch.intensity];
            });
            const anyPct = sessionTime > 0 ? (anyActiveSeconds / sessionTime) * 100 : 0;
            const summaryRow = ['ANY_ACTIVE', '(seconds where 1 channel active)', anyActiveSeconds, anyPct.toFixed(2), ''];
            let csv = headers.join(',') + '\n' + rows.map(r => r.join(',')).join('\n') + '\n' + summaryRow.join(',') + '\n';
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const ts = new Date().toISOString().replace(/[:T]/g, '-').split('.')[0];
            a.download = 'channel_usage_' + ts + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function openModal(modalId) {
            document.getElementById(`modal-${modalId}`).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(`modal-${modalId}`).classList.remove('active');
        }

        function toggleSwitch(element) {
            element.classList.toggle('active');
        }

        function toggleDarkMode(element) {
            element.classList.toggle('active');
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        function openNetworkSetup() {
            closeModal('settings');
            openModal('network');
        }

        function saveNetwork() {
            alert('Network settings saved!');
            closeModal('network');
        }

        function startSession() {
            if (sessionActive) return;

            // Check if at least one channel is active before starting
            const hasActiveChannel = channels.some(c => c.intensity > 0);
            if (!hasActiveChannel) {
                alert(' Please activate at least one channel before starting the session.\n\nUse the + button to increase channel intensity.');
                return;
            }

            sessionActive = true;
            const startBtn = document.getElementById('start-session-btn');
            if (startBtn) {
                startBtn.textContent = ' PAUSE';
                startBtn.classList.add('active');
            }

            // Start timer interval
            sessionInterval = setInterval(() => {
                sessionTime++;
                updateTimerDisplay();

                // Contractions: based on configured interval, count one per active channel
                const interval = sessionParams.contractionIntervalSec || 2;
                if (sessionTime % interval === 0) {
                    const activeCount = channels.filter(c => c.intensity > 0).length;
                    if (activeCount > 0) {
                        contractionCount += activeCount;
                        const ccEl = document.getElementById('contraction-count');
                        if (ccEl) ccEl.textContent = contractionCount;
                    }
                }

                // Accumulate active seconds per channel and update progress bars
                channels.forEach((ch, idx) => {
                    if (ch.intensity > 0) channelActiveSeconds[idx]++;
                });
                if (channels.some(c => c.intensity > 0)) anyActiveSeconds++;
                updateChannelProgress();
                updateActiveSummary();

                // Check if session duration reached
                if (sessionTime >= sessionDuration) {
                    stopSession();
                    alert('Session duration completed!');
                }
            }, 1000);
        }

        function stopSession() {
            if (!sessionActive) return;

            sessionActive = false;
            const startBtn = document.getElementById('start-session-btn');
            if (startBtn) {
                startBtn.textContent = ' START';
                startBtn.classList.remove('active');
            }

            if (sessionInterval) {
                clearInterval(sessionInterval);
                sessionInterval = null;
            }
        }

        function toggleSession() {
            if (sessionActive) {
                stopSession();
            } else {
                startSession();
            }
        }

        function updateTimerDisplay() {
            const mins = Math.floor(sessionTime / 60);
            const secs = sessionTime % 60;
            document.getElementById('timer').textContent =
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            // Update remaining time if element exists
            const remainingEl = document.getElementById('time-remaining');
            if (remainingEl && sessionDuration > 0) {
                const remaining = Math.max(0, sessionDuration - sessionTime);
                const remMins = Math.floor(remaining / 60);
                const remSecs = remaining % 60;
                remainingEl.textContent = `${remMins}:${remSecs.toString().padStart(2, '0')}`;
            }
        }

        function saveSettings() {
            // Save current channel intensities to localStorage
            const settings = {
                channels: channels.map(ch => ({ id: ch.id, intensity: ch.intensity })),
                sessionDuration: sessionDuration,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('np2-settings', JSON.stringify(settings));
            alert('Settings saved successfully!');
        }

        function lockControls() {
            const locked = document.body.classList.toggle('controls-locked');
            if (locked) {
                alert('Controls locked! Click LOCK again to unlock.');
            } else {
                alert('Controls unlocked!');
            }
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            document.getElementById('dark-mode-toggle').classList.add('active');
        }

        function loadTemplate(templateName) {
            if (!templateName) return;

            const templates = {
                walking: [40, 40, 45, 45, 0, 0, 0, 0],
                jogging: [55, 55, 60, 60, 0, 0, 0, 0],
                running: [70, 70, 75, 75, 0, 0, 0, 0],
                stairs: [60, 60, 65, 65, 35, 35, 40, 40],
                jumping: [75, 75, 80, 80, 45, 45, 50, 50]
            };

            const intensities = templates[templateName];
            if (intensities) {
                channels.forEach((ch, idx) => {
                    ch.intensity = intensities[idx];
                    const valueEl = document.getElementById(`ch${idx + 1}-value`);
                    if (valueEl) {
                        valueEl.textContent = intensities[idx];
                        valueEl.style.color = 'var(--color-green-status)';
                        setTimeout(() => valueEl.style.color = '', 500);
                    }
                });

                // Update active highlighting for template-loaded channels
                updateActiveHighlights();

                // Switch to dashboard to see the channels
                switchScreen('dashboard', null);

                setTimeout(() => document.querySelector('.templates-dropdown').value = '', 100);
            }
        }

        function selectTemplateActivity(element, templateType, activityName) {
            // Deselect all in same section
            element.parentElement.querySelectorAll('.template-activity').forEach(t => {
                t.classList.remove('selected');
            });

            // Select clicked template
            element.classList.add('selected');
            selectedTemplate = { type: templateType, activity: activityName };
        }

        // Duration selection for template sessions
        function selectDuration(btn, code, minutes, restMinutes) {
            // Clear previous selection
            document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedDuration = { code, minutes, restMinutes };

            // If sessionParams exists, update durationMinutes
            if (typeof sessionParams === 'object') {
                sessionParams.durationMinutes = minutes;
                updateSessionParameter('durationMinutes', minutes);
                // Update remaining time display if present
                const remainingEl = document.getElementById('time-remaining');
                if (remainingEl) {
                    remainingEl.textContent = `${minutes}:00`;
                }
            }
        }

        function startTemplate() {
            if (!selectedTemplate) {
                alert('Please select a template activity first!');
                return;
            }

            // Switch to template mode if not already
            if (currentMode !== 'template') {
                switchToMode('template', document.querySelectorAll('.nav-btn')[1]);
            }

            // Map activity names to template keys
            const activityMap = {
                'Walking': 'walking',
                'Jogging': 'jogging',
                'Running': 'running',
                'Stairs': 'stairs',
                'Jumping': 'jumping'
            };

            const templateKey = activityMap[selectedTemplate.activity];
            if (templateKey) {
                loadTemplate(templateKey);
                // Start session automatically
                if (!sessionActive) {
                    startSession();
                }
                alert(`Started ${selectedTemplate.activity} template!`);
            }
        }

        // ===== USAGE DATA & CHART RENDERING =====
        const usageData = {
            weekly: () => {
                // Generate deterministic demo data based on week offset for consistency
                const base = Math.max(0, 5 + currentWeekOffset);
                return [
                    2.5 + (base * 0.05), // Mon
                    2.0 + (base * 0.04), // Tue
                    3.2 + (base * 0.03), // Wed
                    1.6 + (base * 0.02), // Thu
                    2.4 + (base * 0.05), // Fri
                    3.0 + (base * 0.06), // Sat
                    2.8 + (base * 0.05)  // Sun
                ];
            },
            monthly: () => {
                // Weekly totals in a month (approx hours)
                return [12.5, 14.2, 11.8, 16.0];
            },
            yearly: () => {
                // Monthly totals (approx hours)
                return [45, 58, 52, 68, 62, 75, 70, 78, 68, 60, 65, 82];
            }
        };

        let currentUsagePeriod = 'weekly';
        let currentWeekOffset = 0;

        function formatHours(val) {
            return (val >= 10 ? val.toFixed(0) : val.toFixed(1)) + 'h';
        }

        function renderUsageChart(period = currentUsagePeriod) {
            // Utility to lighten color (simple HSL manipulation fallback)
            function shadeColor(hex, percent) {
                // Convert hex to RGB
                const num = parseInt(hex.replace('#', ''), 16);
                let r = (num >> 16) & 255;
                let g = (num >> 8) & 255;
                let b = num & 255;
                // Increase each channel
                r = Math.min(255, Math.round(r + (255 - r) * (percent / 100)));
                g = Math.min(255, Math.round(g + (255 - g) * (percent / 100)));
                b = Math.min(255, Math.round(b + (255 - b) * (percent / 100)));
                return `rgb(${r},${g},${b})`;
            }
            currentUsagePeriod = period;
            const container = document.getElementById('usage-bar-chart');
            if (!container) return;
            container.innerHTML = '';
            let data = usageData[period]();
            let labels;
            if (period === 'weekly') labels = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
            else if (period === 'monthly') labels = ['WK1', 'WK2', 'WK3', 'WK4'];
            else labels = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];

            const maxVal = Math.max(...data);
            // Axis ticks (nice rounding)
            const niceMax = maxVal <= 2 ? Math.ceil(maxVal * 2) / 2 : Math.ceil(maxVal);
            const tickCount = 5;
            const ticks = [];
            for (let i = 0; i <= tickCount; i++) {
                const val = (niceMax / tickCount) * i;
                ticks.push(val);
            }
            const axis = document.createElement('div');
            axis.className = 'usage-y-axis';
            ticks.slice().reverse().forEach(t => {
                const tickEl = document.createElement('div');
                tickEl.className = 'tick';
                tickEl.textContent = (t >= 10 ? Math.round(t) : t.toFixed(1)) + 'h';
                axis.appendChild(tickEl);
            });
            container.appendChild(axis);
            // Update stat cards
            const totalHours = data.reduce((a, b) => a + b, 0);
            const sessionsEstimate = Math.round(totalHours * 4); // heuristic
            const contractionsEstimate = Math.round(totalHours * 450); // heuristic
            const hoursEl = document.getElementById('stat-total-hours');
            const sessionsEl = document.getElementById('stat-sessions');
            const contractionsEl = document.getElementById('stat-contractions');
            if (hoursEl) hoursEl.textContent = totalHours >= 10 ? totalHours.toFixed(0) + 'h' : totalHours.toFixed(1) + 'h';
            if (sessionsEl) sessionsEl.textContent = sessionsEstimate;
            if (contractionsEl) contractionsEl.textContent = contractionsEstimate.toLocaleString();
            data.forEach((val, idx) => {
                const wrap = document.createElement('div');
                wrap.className = 'bar-wrapper';
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = ((val / niceMax) * 90 + 5) + '%';
                // Palette-based color (improves visual distinction & accessibility)
                const weeklyPalette = ['#2563EB', '#1D4ED8', '#1E40AF', '#1E3A8A', '#0E7490', '#0D9488', '#0F766E'];
                const monthlyPalette = ['#2563EB', '#0D9488', '#F59E0B', '#6366F1'];
                const yearlyPalette = ['#1D4ED8', '#2563EB', '#0E7490', '#0D9488', '#0F766E', '#059669', '#10B981', '#16A34A', '#65A30D', '#CA8A04', '#D97706', '#EA580C'];
                let baseColor;
                if (period === 'weekly') baseColor = weeklyPalette[idx];
                else if (period === 'monthly') baseColor = monthlyPalette[idx];
                else baseColor = yearlyPalette[idx];
                bar.style.background = `linear-gradient(to top, ${baseColor}, ${shadeColor(baseColor, 30)})`;
                bar.style.boxShadow = '0 2px 4px rgba(0,0,0,0.15)';
                bar.style.minHeight = '8px';
                const value = document.createElement('div');
                value.className = 'bar-value';
                value.textContent = formatHours(val);
                const pctHeight = (val / niceMax);
                if (pctHeight > 0.26) {
                    value.classList.add('inside');
                    // Basic contrast safeguard (if light gradient top produces low contrast, darken text shadow)
                    value.style.textShadow = '0 1px 3px rgba(0,0,0,0.55)';
                } else if (pctHeight < 0.12) {
                    value.classList.add('above-small');
                }
                const tooltip = document.createElement('div');
                tooltip.className = 'bar-tooltip';
                tooltip.textContent = `${labels[idx]}: ${formatHours(val)} total`;
                wrap.appendChild(bar);
                wrap.appendChild(value);
                wrap.appendChild(tooltip);
                container.appendChild(wrap);
            });
            // Detached x-axis labels row
            const labelsRow = document.createElement('div');
            labelsRow.className = 'bar-labels-row';
            labels.forEach(l => {
                const xl = document.createElement('div');
                xl.className = 'x-label';
                xl.textContent = l;
                labelsRow.appendChild(xl);
            });
            container.appendChild(labelsRow);
            // Baseline line
            const baseline = document.createElement('div');
            baseline.className = 'axis-baseline';
            container.appendChild(baseline);
            // Final integrity check
            if (!container.querySelector('.bar-wrapper')) {
                container.innerHTML = '<div style="width:100%;text-align:center;font-size:12px;color:var(--text-secondary);">No usage data available.</div>';
            }
        }

        // Ensure usage chart has bars; re-render if missing (e.g., after lazy load or display changes)
        function ensureUsageChartVisible() {
            const container = document.getElementById('usage-bar-chart');
            if (!container) return;
            const hasBar = container.querySelector('.bar-wrapper');
            if (!hasBar) {
                console.warn('[UsageChart] No bars detected, forcing weekly render.');
                try {
                    renderUsageChart(currentUsagePeriod || 'weekly');
                } catch (e) {
                    console.error('[UsageChart] Forced render failed:', e);
                }
            }
        }

        function getOrdinal(n) {
            const s = ['th', 'st', 'nd', 'rd'];
            const v = n % 100;
            return (s[(v - 20) % 10] || s[v] || s[0]);
        }

        function changeWeek(direction) {
            currentWeekOffset += direction;
            const dateEl = document.getElementById('date-display');
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay() + (currentWeekOffset * 7));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const formatDate = (d) => `${d.getDate()}${getOrdinal(d.getDate())} ${months[d.getMonth()]}`;
            dateEl.textContent = `Week ${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
            // Re-render weekly data when navigating weeks
            if (currentUsagePeriod === 'weekly') renderUsageChart('weekly');
        }

        function switchChartTab(tabEl, period) {
            document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
            tabEl.classList.add('active');
            if (!period) {
                const text = tabEl.textContent.trim().toLowerCase();
                if (text.includes('week')) period = 'weekly';
                else if (text.includes('month')) period = 'monthly';
                else period = 'yearly';
                console.warn('Period missing, inferred as', period);
            }
            console.log('Rendering usage chart for period:', period);
            renderUsageChart(period);
        }

        // Activity selection in garment screens
        function selectActivity(activityEl) {
            // Find all activity-name elements in the same activities-panel
            const panel = activityEl.closest('.activities-panel');
            if (panel) {
                panel.querySelectorAll('.activity-name').forEach(a => a.classList.remove('selected'));
            }
            // Add selected class to clicked activity
            activityEl.classList.add('selected');
        }

        // Timer is now controlled by startSession() and stopSession() functions
        // No auto-start - user must click START button

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderChannels();
            // Initial usage chart render
            renderUsageChart('weekly');

            // Load saved parameters from localStorage
            const savedParams = localStorage.getItem('np2-session-params');
            if (savedParams) {
                try {
                    const params = JSON.parse(savedParams);
                    sessionParams = { ...sessionParams, ...params };
                    sessionDuration = sessionParams.sessionDurationMin * 60;
                    updateTimerDisplay();
                } catch (e) {
                    console.warn('Failed to load saved parameters:', e);
                }
            }
        });

        // Close modals on click outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Tab switching
        document.querySelectorAll('.tab-header').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-header').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
            });
        });

        // ===== USER GUIDE FUNCTIONS =====
        let currentGuideStep = 1;
        const totalGuideSteps = 7;

        function openUserGuide() {
            closeModal('settings');
            currentGuideStep = 1;
            updateGuideStep();
            openModal('user-guide');
        }

        function nextGuideStep() {
            if (currentGuideStep < totalGuideSteps) {
                currentGuideStep++;
                updateGuideStep();
            }
        }

        function previousGuideStep() {
            if (currentGuideStep > 1) {
                currentGuideStep--;
                updateGuideStep();
            }
        }

        function updateGuideStep() {
            // Hide all steps
            document.querySelectorAll('.guide-step').forEach(step => {
                step.classList.remove('active');
            });

            // Show current step
            document.getElementById('guide-step-' + currentGuideStep).classList.add('active');

            // Update progress text
            document.getElementById('guide-step-number').textContent = 'Step ' + currentGuideStep + ' of ' + totalGuideSteps;

            // Update navigation buttons
            const prevBtn = document.getElementById('guide-prev-btn');
            const nextBtn = document.getElementById('guide-next-btn');
            const finishBtn = document.getElementById('guide-finish-btn');

            // Previous button
            prevBtn.disabled = (currentGuideStep === 1);

            // Next/Finish buttons
            if (currentGuideStep === totalGuideSteps) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                finishBtn.style.display = 'none';
            }
        }

        // ===== TUTORIAL FUNCTIONS =====
        let currentTutorial = 1;

        function openTutorial() {
            closeModal('settings');
            currentTutorial = 1;
            updateTutorial();
            openModal('tutorial');
        }

        function switchTutorial(tutorialNum, tabEl) {
            currentTutorial = tutorialNum;

            // Update tabs
            document.querySelectorAll('.tutorial-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            tabEl.classList.add('active');

            updateTutorial();
        }

        function updateTutorial() {
            // Hide all tutorial contents
            document.querySelectorAll('.tutorial-content').forEach(content => {
                content.classList.remove('active');
            });

            // Show current tutorial
            document.getElementById('tutorial-' + currentTutorial).classList.add('active');
        }

        // ===== PARAMETERS FUNCTIONS =====
        function updateSessionParameter(paramName, value) {
            const numValue = parseFloat(value);
            sessionParams[paramName] = isNaN(numValue) ? value : numValue;

            // Update session duration in seconds if that changed
            if (paramName === 'sessionDurationMin') {
                sessionDuration = numValue * 60;
                updateTimerDisplay();
            }

            // Recalculate total cycle time
            updateTotalCycleTime();

            // Save to localStorage
            localStorage.setItem('np2-session-params', JSON.stringify(sessionParams));
        }

        function updateTotalCycleTime() {
            const total = sessionParams.rampUpSec + sessionParams.holdOnSec +
                sessionParams.rampDownSec + sessionParams.offSec;
            const totalCycleEl = document.getElementById('param-total-cycle');
            if (totalCycleEl) {
                totalCycleEl.value = total.toFixed(1) + ' sec';
            }
        }

        function loadParametersIntoModal() {
            // Load current values into modal inputs
            document.getElementById('param-session-duration').value = sessionParams.sessionDurationMin;
            document.getElementById('param-ramp-up').value = sessionParams.rampUpSec;
            document.getElementById('param-hold-on').value = sessionParams.holdOnSec;
            document.getElementById('param-ramp-down').value = sessionParams.rampDownSec;
            document.getElementById('param-off').value = sessionParams.offSec;
            document.getElementById('param-mode').value = sessionParams.mode;
            document.getElementById('param-frequency').value = sessionParams.frequencyHz;
            document.getElementById('param-pulse-width').value = sessionParams.pulseWidthUs;
            document.getElementById('param-pattern').value = sessionParams.pattern;
            document.getElementById('param-display-unit').value = sessionParams.displayUnit;

            // Load max power if admin
            const maxPowerInput = document.getElementById('param-max-power');
            if (maxPowerInput) {
                maxPowerInput.value = sessionParams.maxPowerPercent;
            }

            updateTotalCycleTime();
        } function saveParameters() {
            // Save current parameters
            localStorage.setItem('np2-session-params', JSON.stringify(sessionParams));

            // Update session duration
            sessionDuration = sessionParams.sessionDurationMin * 60;
            updateTimerDisplay();

            alert(' Parameters saved successfully!');
            closeModal('parameters');
        }

        function resetParametersToDefault() {
            if (!confirm('Reset all parameters to default values?')) return;

            // Reset to defaults
            sessionParams = {
                sessionDurationMin: 10,
                rampUpSec: 3,
                holdOnSec: 5,
                rampDownSec: 2,
                offSec: 5,
                mode: 'GAIT',
                frequencyHz: 25,
                pulseWidthUs: 400,
                pattern: 'Synchronous',
                displayUnit: 'Voltage',
                maxPowerPercent: 100
            };

            loadParametersIntoModal();
            localStorage.setItem('np2-session-params', JSON.stringify(sessionParams));
        }        // Load parameters when modal opens
        const originalOpenModal = openModal;
        openModal = function (modalId) {
            originalOpenModal(modalId);
            if (modalId === 'parameters') {
                loadParametersIntoModal();
            }
        };
    </script>
</body>

</html>
